<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëç∑ÂÖ∞ËØ≠A2ËØçÊ±áÂ≠¶‰π†Á≥ªÁªü - LINK+ ÂÆåÊï¥ËØçÊ±áË°®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.2em;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            min-width: 150px;
            margin: 5px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .filter-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .filter-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .search-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .vocabulary-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .cards-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .word-card {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            will-change: transform, box-shadow;
        }

        .word-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .word-card.learned {
            border-color: #4caf50;
            background: linear-gradient(to bottom right, white 95%, #4caf50 5%);
        }

        .word-card.flipped {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .theme-tag {
            position: absolute;
            bottom: 8px;
            left: 8px;
            padding: 3px 8px;
            background: #f0f0f0;
            border-radius: 10px;
            font-size: 11px;
            color: #666;
        }

        .word-card.flipped .theme-tag {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .dutch-word {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .word-card.flipped .dutch-word {
            color: white;
        }

        .speak-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }

        .speak-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .word-card.flipped .speak-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .word-card.flipped .speak-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Êõ¥Â§öÊåâÈíÆÊ†∑Âºè */
        .more-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            background: transparent;
            color: #999;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            z-index: 2;
        }

        .more-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .word-card.flipped .more-btn {
            color: rgba(255, 255, 255, 0.8);
        }

        .word-card.flipped .more-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* ÂàóË°®ËßÜÂõæ‰∏≠ÁöÑÊõ¥Â§öÊåâÈíÆ */
        .vocabulary-table .more-btn {
            background: #f0f0f0 !important;
            border: none !important;
            border-radius: 50% !important;
            width: 30px !important;
            height: 30px !important;
            cursor: pointer !important;
            font-size: 16px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            position: static !important;
        }

        .vocabulary-table .more-btn:hover {
            background: #e0e0e0 !important;
        }

        /* ËØ¶ÁªÜ‰ø°ÊÅØÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .detail-modal {
            width: 700px;
            max-width: 90vw;
            height: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        #detailContent {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            padding-right: 10px;
            /* FirefoxÊªöÂä®Êù° */
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè */
        #detailContent::-webkit-scrollbar {
            width: 8px;
        }

        #detailContent::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #detailContent::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #detailContent::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }

        /* ÈÄâËØçÁøªËØëÊ†∑Âºè */
        .translation-popup {
            position: fixed;
            display: none;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            max-width: 300px;
            animation: fadeIn 0.2s ease;
        }

        .translation-popup.active {
            display: block;
        }

        .translation-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .translation-word {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            padding-right: 40px;
            margin-right: 5px;
        }

        .translation-meaning {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }

        .translation-speak {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #667eea;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            line-height: 1;
        }

        .translation-speak:hover {
            background: #5a67d8;
        }

        /* ÂèØÈÄâ‰∏≠ÊñáÊú¨Ê†∑Âºè */
        .selectable-text {
            user-select: text;
            cursor: text;
        }

        .selectable-text::selection {
            background: #b4d5ff;
            color: #000;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-header {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 20px;
            margin-bottom: 25px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .detail-word {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .detail-pronunciation {
            font-size: 1.2em;
            color: #999;
            margin-bottom: 5px;
        }

        .detail-meaning {
            font-size: 1.4em;
            color: #555;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 12px;
            border-bottom: 1px solid #e8e8e8;
            padding-bottom: 8px;
        }

        .detail-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .detail-tag {
            padding: 6px 12px;
            background: #f5f5f5;
            border-radius: 15px;
            font-size: 14px;
            color: #666;
        }

        .conjugation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .conjugation-table th {
            background: #f8f8f8;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #555;
        }

        .conjugation-table td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .conjugation-table tr:hover {
            background: #f9f9f9;
        }

        .example-sentence {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 3px solid #667eea;
        }

        .example-dutch {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
        }

        .example-english {
            font-size: 1em;
            color: #666;
            font-style: italic;
        }

        .english-meaning {
            color: #666;
            font-size: 1em;
            display: none;
        }

        .word-card.flipped .english-meaning {
            display: block;
            color: white;
        }

        .list-view {
            display: none;
        }

        .list-view.active {
            display: block;
        }

        .cards-view.active {
            display: grid;
        }

        .vocabulary-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .vocabulary-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .vocabulary-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .vocabulary-table tr:hover {
            background: #f5f5f5;
        }

        .theme-badge {
            padding: 3px 8px;
            background: #e8f4f8;
            border-radius: 5px;
            font-size: 12px;
            color: #2196F3;
        }

        .task-badge {
            padding: 3px 8px;
            background: #fff3e0;
            border-radius: 5px;
            font-size: 12px;
            color: #ff9800;
        }

        .action-buttons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 15px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        /* Â≠¶‰π†ËÆ°ÂàíÊ†∑Âºè */
        .study-plan-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .study-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .study-plan-header h3 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        .plan-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .days-input, .day-input {
            width: 60px;
            padding: 5px 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }

        .plan-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .plan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .plan-btn.secondary {
            background: #95a5a6;
        }

        .plan-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .plan-stat {
            flex: 1;
            min-width: 150px;
        }

        .plan-label {
            color: #666;
            font-size: 14px;
        }

        .plan-value {
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }

        .day-range-selector {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .day-range-selector label {
            color: #666;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .cards-view {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* ÁßªÂä®Á´ØË∞ÉÊï¥‰ªäÊó•Â≠¶‰π†ÁªüËÆ°ÊòæÁ§∫ */
            #viewedWordsDisplay {
                font-size: 14px !important;
                padding: 6px 12px !important;
                top: 10px !important;
                left: 10px !important;
            }

            h1 {
                font-size: 1.5em;
                padding: 15px;
            }

            .vocabulary-table {
                font-size: 14px;
                min-width: 100%;
            }

            .vocabulary-table th:first-child,
            .vocabulary-table td:first-child {
                width: 45%;
                word-wrap: break-word;
            }

            .vocabulary-table th:nth-child(2),
            .vocabulary-table td:nth-child(2) {
                width: 45%;
                word-wrap: break-word;
            }

            .vocabulary-table th:last-child,
            .vocabulary-table td:last-child {
                width: 10%;
            }

            .vocabulary-table td {
                padding: 10px 8px;
            }

            .list-view {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -10px;
                padding: 0 10px;
            }

            .detail-modal {
                width: 95%;
                height: 500px;
                max-height: 85vh;
            }

            .detail-word {
                font-size: 2em;
            }

            .stats-container {
                flex-direction: column;
                gap: 10px;
            }

            .stat-item {
                padding: 10px;
            }

            .mode-toggle {
                flex-wrap: wrap;
                gap: 5px;
            }

            .mode-btn {
                flex: 1;
                min-width: 80px;
                padding: 8px 12px;
                font-size: 14px;
            }

            .filter-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }

            .filter-btn {
                padding: 5px 10px;
                font-size: 13px;
            }

            .action-buttons {
                bottom: 20px;
                right: 20px;
                flex-wrap: wrap;
                max-width: 60px;
            }

            .action-btn {
                width: 45px;
                height: 45px;
            }

            .random-word-card {
                padding: 30px 20px;
            }

            .dutch-word {
                font-size: 2em !important;
            }
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .modal-content.detail-modal {
            padding: 30px;
            padding-top: 50px;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #333;
        }

        .random-word-card {
            background: white;
            border: 2px solid #667eea;
            color: #333;
            padding: 60px 40px;
            border-radius: 15px;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
        }

        .random-word-card.learned {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #ffffff 0%, #f0f8f0 100%);
        }

        .random-word-card.learned::before {
            content: '‚úì';
            position: absolute;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .speak-btn-modal {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }

        .speak-btn-modal:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .random-word-card.flipped .speak-btn-modal {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .random-word-card.flipped .speak-btn-modal:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .random-word-card:hover {
            transform: scale(1.02);
        }

        .random-word-card .dutch-word {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 30px;
            color: #667eea;
        }

        .random-word-card .english-meaning {
            font-size: 1.8em;
            display: none;
            color: #555;
        }

        .random-word-card.flipped {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #764ba2;
        }

        .random-word-card.flipped .dutch-word {
            color: white;
        }

        .random-word-card.flipped .english-meaning {
            display: block;
            color: white;
            animation: fadeIn 0.3s ease;
        }

        .random-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .random-btn {
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .random-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .random-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .random-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* ÁôªÂΩïÂíåÂêåÊ≠•Áä∂ÊÄÅÊ†∑Âºè */
        .auth-section {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 14px;
        }

        .sync-icon {
            font-size: 16px;
        }

        .user-email {
            color: #667eea;
            font-weight: 500;
        }

        .login-btn, .logout-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover, .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* ÁôªÂΩïÊ®°ÊÄÅÊ°Ü */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .login-modal.active {
            display: flex;
        }

        .login-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        .login-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }

        .login-subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .email-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .email-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .login-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 30px;
            height: 30px;
            border: none;
            background: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .login-close:hover {
            color: #666;
        }

        @media (max-width: 768px) {
            .auth-section {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }

            .login-content {
                padding: 30px 20px;
                width: 95%;
            }
        }
    </style>

    <!-- PWA ÊîØÊåÅ -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Dutch A2">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <script>
        // Ê≥®ÂÜå Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js');
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üá≥üá± Ëç∑ÂÖ∞ËØ≠A2ËØçÊ±áÂ≠¶‰π†Á≥ªÁªü</h1>
            <div class="subtitle">LINK+ 0‚ÜíA2 ÂÆåÊï¥ËØçÊ±áË°® - ÁÇπÂáªÂç°ÁâáÊü•ÁúãËã±ÊñáÈáä‰πâ</div>
            <div class="auth-section">
                <div id="syncIndicator" class="sync-indicator">
                    <span class="sync-icon">üíæ</span>
                    <span class="sync-text">Êú¨Âú∞Â≠òÂÇ®</span>
                </div>
                <div id="authStatus">
                    <button onclick="showLoginModal()" class="login-btn">ÁôªÂΩïÂêåÊ≠•</button>
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="totalWords">0</div>
                    <div class="stat-label">ÊÄªËØçÊ±áÈáè</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="filteredWords">0</div>
                    <div class="stat-label">ÂΩìÂâçÊòæÁ§∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="learnedWords">0</div>
                    <div class="stat-label">Â∑≤ÊéåÊè°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="progress">0%</div>
                    <div class="stat-label">ÊéåÊè°ËøõÂ∫¶</div>
                </div>
            </div>

            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="cards">Âç°ÁâáÊ®°Âºè</button>
                <button class="mode-btn" data-mode="list">ÂàóË°®Ê®°Âºè</button>
                <button class="mode-btn" data-mode="random">ÈöèÊú∫Â≠¶‰π†</button>
            </div>

            <!-- Â≠¶‰π†ËÆ°ÂàíÂå∫Âüü -->
            <div class="study-plan-section">
                <div class="study-plan-header">
                    <h3>üìÖ Â≠¶‰π†ËÆ°Âàí</h3>
                    <div class="plan-controls">
                        <label>Â≠¶‰π†Â§©Êï∞Ôºö</label>
                        <input type="number" id="studyDaysInput" min="7" max="90" value="30" class="days-input">
                        <button class="plan-btn" onclick="StudyPlanManager.startPlan()">ÂºÄÂßãËÆ°Âàí</button>
                        <button class="plan-btn secondary" onclick="StudyPlanManager.resetPlan()">ÈáçÁΩÆ</button>
                    </div>
                </div>
                <div class="plan-info" id="planInfo" style="display: none;">
                    <div class="plan-stat">
                        <span class="plan-label">ÂΩìÂâçËøõÂ∫¶Ôºö</span>
                        <span class="plan-value">Á¨¨ <span id="currentDay">1</span> Â§© / ÂÖ± <span id="totalDays">30</span> Â§©</span>
                    </div>
                    <div class="plan-stat">
                        <span class="plan-label">‰ªäÊó•ÁõÆÊ†áÔºö</span>
                        <span class="plan-value"><span id="todayLearned">0</span> / <span id="todayTarget">63</span> ‰∏™</span>
                    </div>
                    <div class="plan-stat">
                        <span class="plan-label">ÊÄª‰ΩìËøõÂ∫¶Ôºö</span>
                        <span class="plan-value"><span id="planProgress">0</span>%</span>
                    </div>
                </div>
            </div>

            <!-- ÊåâÂ§©Á≠õÈÄâ -->
            <div class="filter-section" id="dayFilterSection" style="display: none;">
                <span class="filter-label">ÊåâÂ§©Á≠õÈÄâÔºö</span>
                <div class="filter-buttons" id="dayFilters">
                    <button class="filter-btn active" onclick="StudyPlanManager.filterByDay('all')">ÂÖ®ÈÉ®</button>
                    <button class="filter-btn" onclick="StudyPlanManager.filterByDay('today')">‰ªäÂ§©</button>
                    <button class="filter-btn" onclick="StudyPlanManager.filterByDay('range')">ÈÄâÊã©ËåÉÂõ¥</button>
                </div>
                <div class="day-range-selector" id="dayRangeSelector" style="display: none;">
                    <label>‰ªéÁ¨¨</label>
                    <input type="number" id="dayRangeStart" min="1" max="90" value="1" class="day-input">
                    <label>Â§©Âà∞Á¨¨</label>
                    <input type="number" id="dayRangeEnd" min="1" max="90" value="7" class="day-input">
                    <label>Â§©</label>
                    <button class="filter-btn" onclick="StudyPlanManager.applyDayRange()">Â∫îÁî®</button>
                </div>
            </div>

            <div class="search-section">
                <input type="text" class="search-box" id="searchBox" placeholder="ÊêúÁ¥¢Ëç∑ÂÖ∞ËØ≠ÊàñËã±ÊñáÂçïËØç...">
                <button class="filter-btn" onclick="clearSearch()">Ê∏ÖÁ©∫</button>
            </div>

            <div class="filter-section">
                <span class="filter-label">Êåâ‰∏ªÈ¢òÁ≠õÈÄâÔºö</span>
                <div class="filter-buttons" id="themeFilters">
                    <button class="filter-btn active" data-theme="all" onclick="filterByTheme('all')">ÂÖ®ÈÉ®‰∏ªÈ¢ò</button>
                </div>
            </div>

            <div class="filter-section">
                <span class="filter-label">ÊåâÂ≠óÊØçÁ≠õÈÄâÔºö</span>
                <div class="filter-buttons" id="letterFilters">
                    <button class="filter-btn active" data-letter="all" onclick="filterByLetter('all')">ÂÖ®ÈÉ®</button>
                </div>
            </div>
        </div>

        <div class="vocabulary-container">
            <div class="cards-view active" id="cardsView"></div>
            <div class="list-view" id="listView">
                <table class="vocabulary-table">
                    <thead>
                        <tr>
                            <th>Ëç∑ÂÖ∞ËØ≠</th>
                            <th>Ëã±Êñá</th>
                            <th style="width: 50px; text-align: center;">Êõ¥Â§ö</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn" onclick="shareApp()" title="ÂàÜ‰∫´ÁΩëÁ´ô">üì§</button>
            <button class="action-btn" onclick="shuffleWords()" title="ÈöèÊú∫ÊéíÂ∫è">üîÄ</button>
            <button class="action-btn" onclick="resetProgress()" title="ÈáçÁΩÆÊéåÊè°">üîÑ</button>
            <button class="action-btn" onclick="exportData()" title="ÂØºÂá∫ÊéåÊè°">üíæ</button>
            <button class="action-btn" onclick="importData()" title="ÂØºÂÖ•ÊéåÊè°">üìÇ</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
        </div>
    </div>

    <!-- ÈöèÊú∫Â≠¶‰π†Ê®°ÊÄÅÊ°Ü -->
    <div id="randomModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="modalCloseBtn">√ó</button>
            <!-- ‰ªäÊó•Â≠¶‰π†ÁªüËÆ° -->
            <div id="viewedWordsDisplay" style="
                position: absolute;
                top: 20px;
                left: 20px;
                color: white;
                font-size: 18px;
                font-weight: bold;
                background: rgba(0,0,0,0.3);
                padding: 8px 16px;
                border-radius: 20px;
                z-index: 10001;">
                ‰ªäÊó•Â∑≤Â≠¶‰π†: 0 ‰∏™ÂçïËØç
            </div>
            <div id="randomCardContainer"></div>
        </div>
    </div>

    <!-- ËØ¶ÁªÜ‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü -->
    <div id="detailModal" class="modal-overlay" onclick="handleDetailModalClick(event)">
        <div class="modal-content detail-modal">
            <button class="modal-close" onclick="closeDetailModal()">√ó</button>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- ÈÄâËØçÁøªËØëÂºπÂá∫Ê°Ü -->
    <div id="translationPopup" class="translation-popup">
        <div class="translation-content">
            <div class="translation-word"></div>
            <div class="translation-meaning"></div>
            <button class="translation-speak" onclick="speakSelection()">üîä</button>
        </div>
    </div>

    <script src="vocabulary-data.js"></script>
    <script>
        // vocabulary is loaded from vocabulary-data.js

        let learnedWords = new Set();
        let currentFilter = 'all';
        let currentLetter = 'all';
        let currentMode = 'cards';
        let currentDayFilter = 'all'; // Êñ∞Â¢ûÔºöÂΩìÂâçÂ§©Êï∞Á≠õÈÄâ

        // Â≠¶‰π†ËÆ°ÂàíÁÆ°ÁêÜÂô®
        const StudyPlanManager = {
            totalDays: 30,
            wordsPerDay: 0,
            startDate: null,
            currentDay: 1,
            dayAssignments: {},
            isActive: false,
            dayRange: { start: 1, end: 7 },
            todayCompleted: false,

            // ÂàùÂßãÂåñÊàñÂä†ËΩΩ‰øùÂ≠òÁöÑËÆ°Âàí
            init() {
                const saved = localStorage.getItem('dutchA2_studyPlan');
                if (saved) {
                    const plan = JSON.parse(saved);
                    Object.assign(this, plan);
                    if (this.isActive) {
                        this.updateCurrentDay();
                        this.showPlanInfo();
                        document.getElementById('dayFilterSection').style.display = 'block';
                    }
                }
            },

            // ÂºÄÂßãÊñ∞ËÆ°Âàí
            startPlan() {
                const daysInput = document.getElementById('studyDaysInput');
                const days = parseInt(daysInput.value);

                if (days < 7 || days > 90) {
                    alert('ËØ∑ËæìÂÖ•7-90‰πãÈó¥ÁöÑÂ§©Êï∞');
                    return;
                }

                this.totalDays = days;
                this.wordsPerDay = Math.ceil(vocabulary.length / days);
                this.startDate = new Date().toISOString().split('T')[0];
                this.currentDay = 1;
                this.isActive = true;

                // ÂàÜÈÖçÂçïËØçÂà∞ÊØèÂ§©
                this.assignWordsTodays();

                // ÊòæÁ§∫ËÆ°Âàí‰ø°ÊÅØ
                this.showPlanInfo();

                // ÊòæÁ§∫Â§©Êï∞Á≠õÈÄâ
                document.getElementById('dayFilterSection').style.display = 'block';

                // ÁîüÊàêÂ§©Êï∞ÊåâÈíÆ
                this.generateDayButtons();

                // ‰øùÂ≠òËÆ°Âàí
                this.savePlan();

                alert(`Â≠¶‰π†ËÆ°ÂàíÂ∑≤ÂêØÂä®ÔºÅ\\nÊÄªÂÖ±${days}Â§©ÔºåÊØèÂ§©Á∫¶${this.wordsPerDay}‰∏™ÂçïËØç`);

                // Â∫îÁî®‰ªäÂ§©ÁöÑÁ≠õÈÄâ
                this.filterByDay('today');
            },

            // ÂàÜÈÖçÂçïËØçÂà∞ÊØèÂ§©
            assignWordsTodays() {
                this.dayAssignments = {};
                const shuffled = [...vocabulary].sort(() => Math.random() - 0.5);

                for (let day = 1; day <= this.totalDays; day++) {
                    const start = (day - 1) * this.wordsPerDay;
                    const end = Math.min(start + this.wordsPerDay, shuffled.length);
                    this.dayAssignments[day] = shuffled.slice(start, end).map(w => w.dutch);
                }
            },

            // Êõ¥Êñ∞ÂΩìÂâçÂ§©Êï∞
            updateCurrentDay() {
                if (!this.startDate) return;

                const start = new Date(this.startDate);
                const today = new Date();
                const diffTime = today - start;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

                const prevDay = this.currentDay;
                this.currentDay = Math.min(Math.max(1, diffDays), this.totalDays);

                // Â¶ÇÊûúËøõÂÖ•Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÈáçÁΩÆÂÆåÊàêÊ†áËÆ∞
                if (prevDay !== this.currentDay) {
                    this.todayCompleted = false;
                }
            },

            // ÊòæÁ§∫ËÆ°Âàí‰ø°ÊÅØ
            showPlanInfo() {
                document.getElementById('planInfo').style.display = 'flex';
                document.getElementById('currentDay').textContent = this.currentDay;
                document.getElementById('totalDays').textContent = this.totalDays;
                document.getElementById('todayTarget').textContent = this.wordsPerDay;

                // ËÆ°ÁÆó‰ªäÊó•Â∑≤Â≠¶‰π†
                const todayWords = this.dayAssignments[this.currentDay] || [];
                const todayLearned = todayWords.filter(word => learnedWords.has(word)).length;
                document.getElementById('todayLearned').textContent = todayLearned;

                // ËÆ°ÁÆóÊÄª‰ΩìËøõÂ∫¶
                const planProgress = Math.round((this.currentDay / this.totalDays) * 100);
                document.getElementById('planProgress').textContent = planProgress;
            },

            // Êõ¥Êñ∞ËÆ°ÂàíÁªüËÆ°ÔºàÂÆûÊó∂Êõ¥Êñ∞Ôºâ
            updatePlanStats() {
                if (!this.isActive) return;

                // ËÆ°ÁÆó‰ªäÊó•Â∑≤Â≠¶‰π†
                const todayWords = this.dayAssignments[this.currentDay] || [];
                const todayLearned = todayWords.filter(word => learnedWords.has(word)).length;
                const todayLearnedEl = document.getElementById('todayLearned');
                if (todayLearnedEl) {
                    todayLearnedEl.textContent = todayLearned;
                }
            },

            // ÁîüÊàêÂ§©Êï∞ÊåâÈíÆ
            generateDayButtons() {
                const container = document.getElementById('dayFilters');

                // ‰øùÁïôÂâç‰∏â‰∏™ÊåâÈíÆÔºàÂÖ®ÈÉ®„ÄÅ‰ªäÂ§©„ÄÅÈÄâÊã©ËåÉÂõ¥Ôºâ
                const existingButtons = container.querySelectorAll('.filter-btn').length;
                if (existingButtons <= 3) {
                    // Ê∑ªÂä†Âø´ÈÄüÈÄâÊã©ÊåâÈíÆ
                    for (let i = 1; i <= Math.min(7, this.totalDays); i++) {
                        const btn = document.createElement('button');
                        btn.className = 'filter-btn';
                        btn.textContent = `Á¨¨${i}Â§©`;
                        btn.onclick = () => this.filterByDay(i);
                        container.appendChild(btn);
                    }
                }
            },

            // ÊåâÂ§©Á≠õÈÄâ
            filterByDay(day) {
                currentDayFilter = day;

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                document.querySelectorAll('#dayFilters .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                if (day === 'all') {
                    document.querySelector('#dayFilters .filter-btn').classList.add('active');
                    document.getElementById('dayRangeSelector').style.display = 'none';
                } else if (day === 'today') {
                    document.querySelectorAll('#dayFilters .filter-btn')[1].classList.add('active');
                    document.getElementById('dayRangeSelector').style.display = 'none';
                    currentDayFilter = this.currentDay;
                } else if (day === 'range') {
                    document.querySelectorAll('#dayFilters .filter-btn')[2].classList.add('active');
                    document.getElementById('dayRangeSelector').style.display = 'block';
                    return; // Á≠âÂæÖÁî®Êà∑Â∫îÁî®ËåÉÂõ¥
                } else if (typeof day === 'number') {
                    // ÊâæÂà∞ÂØπÂ∫îÁöÑÂ§©Êï∞ÊåâÈíÆ
                    const dayBtn = Array.from(document.querySelectorAll('#dayFilters .filter-btn'))
                        .find(btn => btn.textContent === `Á¨¨${day}Â§©`);
                    if (dayBtn) dayBtn.classList.add('active');
                    document.getElementById('dayRangeSelector').style.display = 'none';
                }

                // Â∫îÁî®Á≠õÈÄâ
                displayVocabulary();

                // Êõ¥Êñ∞ÁªüËÆ°
                if (this.isActive && day !== 'all') {
                    this.updatePlanStats();
                }
            },

            // Â∫îÁî®Â§©Êï∞ËåÉÂõ¥
            applyDayRange() {
                const start = parseInt(document.getElementById('dayRangeStart').value);
                const end = parseInt(document.getElementById('dayRangeEnd').value);

                if (start < 1 || end > this.totalDays || start > end) {
                    alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂ§©Êï∞ËåÉÂõ¥');
                    return;
                }

                this.dayRange = { start, end };
                currentDayFilter = 'range';
                displayVocabulary();
            },

            // Ëé∑ÂèñÁ≠õÈÄâÂêéÁöÑÂçïËØç
            getFilteredWords() {
                if (!this.isActive || currentDayFilter === 'all') {
                    return vocabulary;
                }

                let wordsToShow = [];

                if (currentDayFilter === 'range') {
                    for (let day = this.dayRange.start; day <= this.dayRange.end; day++) {
                        wordsToShow = wordsToShow.concat(this.dayAssignments[day] || []);
                    }
                } else {
                    const day = typeof currentDayFilter === 'number' ? currentDayFilter : this.currentDay;
                    wordsToShow = this.dayAssignments[day] || [];
                }

                return vocabulary.filter(word => wordsToShow.includes(word.dutch));
            },

            // Êõ¥Êñ∞ËÆ°ÂàíÁªüËÆ°
            updatePlanStats() {
                if (!this.isActive) return;

                const todayWords = this.dayAssignments[this.currentDay] || [];
                const todayLearned = todayWords.filter(word => learnedWords.has(word)).length;
                document.getElementById('todayLearned').textContent = todayLearned;
            },

            // ÈáçÁΩÆËÆ°Âàí
            resetPlan() {
                if (!confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÂ≠¶‰π†ËÆ°ÂàíÂêóÔºü')) return;

                this.isActive = false;
                this.dayAssignments = {};
                currentDayFilter = 'all';

                document.getElementById('planInfo').style.display = 'none';
                document.getElementById('dayFilterSection').style.display = 'none';

                localStorage.removeItem('dutchA2_studyPlan');

                displayVocabulary();
                alert('Â≠¶‰π†ËÆ°ÂàíÂ∑≤ÈáçÁΩÆ');
            },

            // ‰øùÂ≠òËÆ°Âàí
            savePlan() {
                const planData = {
                    totalDays: this.totalDays,
                    wordsPerDay: this.wordsPerDay,
                    startDate: this.startDate,
                    currentDay: this.currentDay,
                    dayAssignments: this.dayAssignments,
                    isActive: this.isActive
                };

                localStorage.setItem('dutchA2_studyPlan', JSON.stringify(planData));

                // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÂêåÊ≠•Âà∞‰∫ëÁ´Ø
                if (typeof SyncManager !== 'undefined') {
                    SyncManager.scheduleSave();
                }
            }
        };

        // Èò≤ÊäñÂáΩÊï∞
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // ÈîÆÁõòÂØºËà™ÁÆ°ÁêÜÂô®
        const KeyboardNavigation = {
            currentIndex: -1,
            cards: [],

            init() {
                document.addEventListener('keydown', (e) => this.handleKeyPress(e));
            },

            updateCards() {
                // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÊâÄÊúâÂç°Áâá
                if (currentMode === 'cards') {
                    this.cards = Array.from(document.querySelectorAll('#cardsView .word-card'));
                } else {
                    this.cards = [];
                }
            },

            handleKeyPress(e) {
                // Â¶ÇÊûúÊ≠£Âú®ËæìÂÖ•Ôºå‰∏çÂ§ÑÁêÜÂø´Êç∑ÈîÆ
                if (document.activeElement.tagName === 'INPUT') return;

                // Âè™Âú®Âç°ÁâáÊ®°Âºè‰∏ãÂêØÁî®ÂØºËà™
                if (currentMode !== 'cards' || this.cards.length === 0) {
                    // ÈöèÊú∫Ê®°ÂºèÁöÑÈîÆÁõò‰∫ã‰ª∂Â∑≤ÁªèÂú®ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®‰∏≠Â§ÑÁêÜ‰∫ÜÔºåËøôÈáå‰∏çÈúÄË¶ÅÈáçÂ§çÂ§ÑÁêÜ
                    return;
                }

                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        this.navigate(-1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        this.navigate(1);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.navigateRow(-1);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        this.navigateRow(1);
                        break;
                    case ' ':
                    case 'Enter':
                        e.preventDefault();
                        this.toggleCurrentCard();
                        break;
                    case 's':
                    case 'S':
                        e.preventDefault();
                        this.speakCurrentCard();
                        break;
                }
            },

            navigate(direction) {
                if (this.cards.length === 0) return;

                this.currentIndex += direction;
                if (this.currentIndex < 0) this.currentIndex = this.cards.length - 1;
                if (this.currentIndex >= this.cards.length) this.currentIndex = 0;

                this.focusCard();
            },

            navigateRow(direction) {
                if (this.cards.length === 0) return;

                // ËÆ°ÁÆóÊØèË°åÁöÑÂç°ÁâáÊï∞
                const container = document.getElementById('cardsView');
                const containerWidth = container.offsetWidth;
                const cardWidth = this.cards[0].offsetWidth + 15; // ÂåÖÊã¨gap
                const cardsPerRow = Math.floor(containerWidth / cardWidth);

                this.currentIndex += cardsPerRow * direction;
                this.currentIndex = Math.max(0, Math.min(this.cards.length - 1, this.currentIndex));

                this.focusCard();
            },

            focusCard() {
                // ÁßªÈô§‰πãÂâçÁöÑÁÑ¶ÁÇπ
                this.cards.forEach(card => card.style.outline = 'none');

                if (this.currentIndex >= 0 && this.currentIndex < this.cards.length) {
                    const card = this.cards[this.currentIndex];
                    card.style.outline = '3px solid #667eea';
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            },

            toggleCurrentCard() {
                if (this.currentIndex >= 0 && this.currentIndex < this.cards.length) {
                    const card = this.cards[this.currentIndex];
                    card.click();
                }
            },

            speakCurrentCard() {
                if (this.currentIndex >= 0 && this.currentIndex < this.cards.length) {
                    const card = this.cards[this.currentIndex];
                    const speakBtn = card.querySelector('.speak-btn');
                    if (speakBtn) speakBtn.click();
                }
            }
        };

        // ÂèëÈü≥ÁÆ°ÁêÜÂô®
        const SpeechManager = {
            synth: window.speechSynthesis,
            voices: [],
            dutchVoice: null,

            init() {
                // Âä†ËΩΩËØ≠Èü≥ÂàóË°®
                this.loadVoices();

                // Êüê‰∫õÊµèËßàÂô®ÈúÄË¶ÅÁ≠âÂæÖvoicesÂä†ËΩΩ
                if (this.synth.onvoiceschanged !== undefined) {
                    this.synth.onvoiceschanged = () => this.loadVoices();
                }
            },

            loadVoices() {
                this.voices = this.synth.getVoices();

                // Êü•ÊâæËç∑ÂÖ∞ËØ≠ËØ≠Èü≥
                this.dutchVoice = this.voices.find(voice =>
                    voice.lang.includes('nl') || voice.lang.includes('NL')
                );

                // Â¶ÇÊûúÊ≤°ÊúâËç∑ÂÖ∞ËØ≠ÔºåÂ∞ùËØï‰ΩøÁî®ÈªòËÆ§ËØ≠Èü≥
                if (!this.dutchVoice && this.voices.length > 0) {
                    this.dutchVoice = this.voices[0];
                }
            },

            speak(text) {
                // ÂÅúÊ≠¢‰πãÂâçÁöÑÂèëÈü≥
                this.synth.cancel();

                const utterance = new SpeechSynthesisUtterance(text);

                // ËÆæÁΩÆËç∑ÂÖ∞ËØ≠
                utterance.lang = 'nl-NL';

                // Â¶ÇÊûúÊúâËç∑ÂÖ∞ËØ≠ËØ≠Èü≥Ôºå‰ΩøÁî®ÂÆÉ
                if (this.dutchVoice) {
                    utterance.voice = this.dutchVoice;
                }

                // Ë∞ÉÊï¥ËØ≠ÈÄüÂíåÈü≥Ë∞É
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                // ÂèëÈü≥
                this.synth.speak(utterance);
            },

            isSupported() {
                return 'speechSynthesis' in window;
            }
        };

        // ËôöÊãüÊªöÂä®ÁÆ°ÁêÜÂô®
        const VirtualScroller = {
            BATCH_SIZE: 50, // ÊØèÊâπÂä†ËΩΩ50‰∏™Âç°Áâá
            observer: null,
            loadedCount: 0,
            currentWords: [],
            container: null,

            init(words) {
                this.currentWords = words;
                this.loadedCount = 0;
                this.container = document.getElementById('cardsView');

                // ÂàõÂª∫Intersection Observer
                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            this.loadMore();
                        }
                    });
                }, {
                    root: null,
                    rootMargin: '100px',
                    threshold: 0.1
                });

                // ÂàùÂßãÂä†ËΩΩ
                this.loadBatch();
            },

            loadBatch() {
                const start = this.loadedCount;
                const end = Math.min(start + this.BATCH_SIZE, this.currentWords.length);

                for (let i = start; i < end; i++) {
                    const card = createWordCard(this.currentWords[i]);
                    this.container.appendChild(card);
                }

                this.loadedCount = end;

                // Ê∑ªÂä†Âä†ËΩΩËß¶ÂèëÂô®
                if (this.loadedCount < this.currentWords.length) {
                    this.addLoadTrigger();
                }
            },

            loadMore() {
                if (this.loadedCount < this.currentWords.length) {
                    this.removeTrigger();
                    this.loadBatch();
                }
            },

            addLoadTrigger() {
                const trigger = document.createElement('div');
                trigger.className = 'virtual-scroll-trigger';
                trigger.style.height = '1px';
                trigger.style.visibility = 'hidden';
                this.container.appendChild(trigger);
                this.observer.observe(trigger);
            },

            removeTrigger() {
                const trigger = this.container.querySelector('.virtual-scroll-trigger');
                if (trigger) {
                    this.observer.unobserve(trigger);
                    trigger.remove();
                }
            },

            destroy() {
                if (this.observer) {
                    this.observer.disconnect();
                }
                this.loadedCount = 0;
                this.currentWords = [];
            }
        };

        // LocalStorageÁÆ°ÁêÜ
        const StorageManager = {
            KEYS: {
                LEARNED_WORDS: 'dutchA2_learnedWords',
                FILTER_THEME: 'dutchA2_filterTheme',
                FILTER_LETTER: 'dutchA2_filterLetter',
                VIEW_MODE: 'dutchA2_viewMode'
            },

            saveLearnedWords() {
                try {
                    localStorage.setItem(this.KEYS.LEARNED_WORDS, JSON.stringify([...learnedWords]));
                } catch(e) {
                    console.error('Failed to save learned words:', e);
                }
            },

            loadLearnedWords() {
                try {
                    const saved = localStorage.getItem(this.KEYS.LEARNED_WORDS);
                    if (saved) {
                        learnedWords = new Set(JSON.parse(saved));
                    }
                } catch(e) {
                    console.error('Failed to load learned words:', e);
                }
            },

            savePreferences() {
                try {
                    localStorage.setItem(this.KEYS.FILTER_THEME, currentFilter);
                    localStorage.setItem(this.KEYS.FILTER_LETTER, currentLetter);
                    localStorage.setItem(this.KEYS.VIEW_MODE, currentMode);
                } catch(e) {
                    console.error('Failed to save preferences:', e);
                }
            },

            loadPreferences() {
                try {
                    const savedTheme = localStorage.getItem(this.KEYS.FILTER_THEME);
                    const savedLetter = localStorage.getItem(this.KEYS.FILTER_LETTER);
                    const savedMode = localStorage.getItem(this.KEYS.VIEW_MODE);

                    if (savedTheme) currentFilter = savedTheme;
                    if (savedLetter) currentLetter = savedLetter;
                    if (savedMode) currentMode = savedMode;
                } catch(e) {
                    console.error('Failed to load preferences:', e);
                }
            }
        };

        // ÂàùÂßãÂåñ
        function init() {
            // ÂÖàÂä†ËΩΩ‰øùÂ≠òÁöÑÊï∞ÊçÆ
            StorageManager.loadLearnedWords();
            StorageManager.loadPreferences();

            // ÂàùÂßãÂåñÂ≠¶‰π†ËÆ°Âàí
            StudyPlanManager.init();

            // ÂàùÂßãÂåñ Supabase
            if (typeof SyncManager !== 'undefined') {
                SyncManager.init();
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
                SyncManager.checkAuth().then(user => {
                    if (user) {
                        console.log('Already logged in as:', user.email);
                    }
                });
            }

            // ÂàùÂßãÂåñÂèëÈü≥ÂäüËÉΩ
            SpeechManager.init();

            // ÂàùÂßãÂåñÈîÆÁõòÂØºËà™
            KeyboardNavigation.init();

            // ÂàùÂßãÂåñÈÄâËØçÁøªËØëÂäüËÉΩ
            SelectionTranslator.init();

            extractThemes();
            extractLetters();

            // ÊÅ¢Â§ç‰øùÂ≠òÁöÑÁ≠õÈÄâÁä∂ÊÄÅ
            restoreFilterStates();

            displayVocabulary();
            updateStats();
            setupEventListeners();
        }

        // ÊÅ¢Â§çÁ≠õÈÄâÁä∂ÊÄÅ
        function restoreFilterStates() {
            // ÊÅ¢Â§ç‰∏ªÈ¢òÁ≠õÈÄâ
            if (currentFilter !== 'all') {
                document.querySelectorAll('#themeFilters .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.theme === currentFilter) {
                        btn.classList.add('active');
                    }
                });
            }

            // ÊÅ¢Â§çÂ≠óÊØçÁ≠õÈÄâ
            if (currentLetter !== 'all') {
                document.querySelectorAll('#letterFilters .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.letter === currentLetter) {
                        btn.classList.add('active');
                    }
                });
            }

            // ÊÅ¢Â§çËßÜÂõæÊ®°Âºè
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === currentMode) {
                    btn.classList.add('active');
                }
            });

            document.getElementById('cardsView').style.display = currentMode === 'list' ? 'none' : 'grid';
            document.getElementById('listView').style.display = currentMode === 'list' ? 'block' : 'none';
        }

        // ÊèêÂèñ‰∏ªÈ¢ò
        function extractThemes() {
            const themes = [...new Set(vocabulary.map(word => word.theme))].sort((a, b) => a - b);
            const themeNames = {
                1: "Âü∫Á°Ä", 2: "È£üÁâ©", 3: "Êó•Â∏∏", 4: "È•ÆÈ£ü", 5: "‰ΩèÊàø",
                6: "‰∫§ÈÄö", 7: "ÂÅ•Â∫∑", 8: "Ê¥ªÂä®", 9: "Ë¥≠Áâ©", 10: "ÂÆâÂÖ®",
                11: "Êó∂Èó¥", 12: "ÊïôËÇ≤", 13: "ÂÆ∂Â±Ö", 14: "ÂÖ≥Á≥ª", 15: "Â§ñË°®",
                16: "Ë°åÊîø", 17: "Â∑•‰Ωú", 18: "Ëá™ÁÑ∂", 19: "ÁªèÊµé", 20: "Á§æ‰ºö"
            };

            const filtersDiv = document.getElementById('themeFilters');
            themes.forEach(theme => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.dataset.theme = theme;
                btn.textContent = `‰∏ªÈ¢ò ${theme} - ${themeNames[theme] || 'ÂÖ∂‰ªñ'}`;
                btn.onclick = () => filterByTheme(theme);
                filtersDiv.appendChild(btn);
            });
        }

        // ÊèêÂèñÂ≠óÊØç
        function extractLetters() {
            const letters = [...new Set(vocabulary.map(word => word.dutch[0].toUpperCase()))].sort();
            const filtersDiv = document.getElementById('letterFilters');

            letters.forEach(letter => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.dataset.letter = letter;
                btn.textContent = letter;
                btn.onclick = () => filterByLetter(letter);
                filtersDiv.appendChild(btn);
            });
        }

        // ÊòæÁ§∫ËØçÊ±á
        function displayVocabulary(forceRandomDisplay = false) {
            let filtered = vocabulary;

            // Â∫îÁî®Â≠¶‰π†ËÆ°ÂàíÁ≠õÈÄâÔºà‰ºòÂÖàÁ∫ßÊúÄÈ´òÔºâ
            if (StudyPlanManager.isActive && currentDayFilter !== 'all') {
                filtered = StudyPlanManager.getFilteredWords();
            }

            // Â∫îÁî®‰∏ªÈ¢òÁ≠õÈÄâ
            if (currentFilter !== 'all') {
                filtered = filtered.filter(word => word.theme == currentFilter);
            }

            // Â∫îÁî®Â≠óÊØçÁ≠õÈÄâ
            if (currentLetter !== 'all') {
                filtered = filtered.filter(word => word.dutch[0].toUpperCase() === currentLetter);
            }

            // Â∫îÁî®ÊêúÁ¥¢Á≠õÈÄâ
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(word =>
                    word.dutch.toLowerCase().includes(searchTerm) ||
                    word.english.toLowerCase().includes(searchTerm)
                );
            }

            if (currentMode === 'cards') {
                displayCards(filtered);
            } else if (currentMode === 'list') {
                displayList(filtered);
            } else if (currentMode === 'random') {
                // Âè™ÊúâÂú®ÊòéÁ°ÆË¶ÅÊ±ÇÊòæÁ§∫ÈöèÊú∫Â≠¶‰π†ÔºàÁÇπÂáªÈöèÊú∫Â≠¶‰π†ÊåâÈíÆÔºâÊó∂ÊâçÊòæÁ§∫‰∏ªÈ¢òÈÄâÊã©Âô®
                if (forceRandomDisplay) {
                    displayRandom(filtered);
                } else {
                    // Âê¶ÂàôÊòæÁ§∫Âç°ÁâáÊ®°Âºè
                    displayCards(filtered);
                }
            }

            document.getElementById('filteredWords').textContent = filtered.length;

            // Êõ¥Êñ∞ÈîÆÁõòÂØºËà™ÁöÑÂç°ÁâáÂàóË°®
            setTimeout(() => KeyboardNavigation.updateCards(), 100);
        }

        // ÊòæÁ§∫Âç°Áâá
        function displayCards(words) {
            const container = document.getElementById('cardsView');
            container.innerHTML = '';

            // Ê∏ÖÁêÜ‰πãÂâçÁöÑËôöÊãüÊªöÂä®Âô®
            VirtualScroller.destroy();

            // Â¶ÇÊûúÂçïËØçÊï∞ÈáèËæÉÂ∞ëÔºåÁõ¥Êé•Ê∏≤Êüì
            if (words.length <= 100) {
                words.forEach(word => {
                    const card = createWordCard(word);
                    container.appendChild(card);
                });
            } else {
                // ‰ΩøÁî®ËôöÊãüÊªöÂä®
                VirtualScroller.init(words);
            }
        }

        // Ëé∑ÂèñËØçÊÄßÊ†áËÆ∞ - Êõ¥ÂáÜÁ°ÆÁöÑËØçÊÄßÂà§Êñ≠
        function getWordTypeTag(word) {
            const dutchWord = word.dutch.toLowerCase();
            const englishWord = word.english.toLowerCase();

            // 1. ÂÖàÊ£ÄÊü•ÁâπÂÆöËØçÊÄßÁöÑÊòéÊòæÁâπÂæÅ

            // ‰ªãËØçÂà§Êñ≠ - ÊúÄÂÖàÂà§Êñ≠ÔºåÂõ†‰∏∫‰ªãËØçÈÄöÂ∏∏ÂæàÁü≠
            const prepositions = ['in', 'op', 'aan', 'bij', 'met', 'naar', 'van', 'voor', 'achter', 'onder', 'boven',
                                  'tussen', 'naast', 'over', 'door', 'uit', 'tot', 'sinds', 'tijdens', 'zonder', 'tegen', 'via'];
            if (prepositions.includes(dutchWord)) {
                return 'prep.';
            }

            // ËøûËØçÂà§Êñ≠
            const conjunctions = ['en', 'of', 'maar', 'want', 'omdat', 'dus', 'als', 'dat', 'toen', 'terwijl', 'hoewel', 'indien'];
            if (conjunctions.includes(dutchWord)) {
                return 'conj.';
            }

            // ‰ª£ËØçÂà§Êñ≠
            const pronouns = ['ik', 'jij', 'hij', 'zij', 'het', 'wij', 'jullie', 'u', 'mij', 'jou', 'hem', 'haar',
                             'ons', 'hun', 'deze', 'die', 'dit', 'dat', 'wat', 'wie', 'waar', 'wanneer', 'welke'];
            if (pronouns.includes(dutchWord)) {
                return 'pron.';
            }

            // ÂâØËØçÂà§Êñ≠
            const adverbs = ['vaak', 'altijd', 'nooit', 'soms', 'meestal', 'zelden', 'ooit', 'heel', 'zeer', 'erg',
                            'wel', 'niet', 'ook', 'nog', 'al', 'pas', 'hier', 'daar', 'waar', 'overal', 'nergens',
                            'nu', 'dan', 'toen', 'straks', 'vandaag', 'morgen', 'gisteren', 'misschien', 'zeker',
                            'natuurlijk', 'graag', 'eerst', 'meest', 'minst'];
            if (adverbs.includes(dutchWord) || (englishWord.endsWith('ly') && !englishWord.includes(' '))) {
                return 'adv.';
            }

            // 2. ÂΩ¢ÂÆπËØçÂà§Êñ≠ - Êõ¥Á≤æÁ°ÆÁöÑËßÑÂàô
            // ÂΩ¢ÂÆπËØçËØçÂ∞æ
            if (dutchWord.endsWith('ig') || dutchWord.endsWith('lijk') || dutchWord.endsWith('baar') ||
                dutchWord.endsWith('loos') || dutchWord.endsWith('vol') || dutchWord.endsWith('rijk')) {
                return 'adj.';
            }

            // Â∏∏ËßÅÂΩ¢ÂÆπËØçÂàóË°®
            const commonAdjectives = [
                'goed', 'slecht', 'groot', 'klein', 'nieuw', 'oud', 'jong', 'mooi', 'lelijk',
                'lang', 'kort', 'hoog', 'laag', 'dik', 'dun', 'breed', 'smal',
                'warm', 'koud', 'heet', 'koel', 'droog', 'nat', 'schoon', 'vies',
                'snel', 'langzaam', 'vroeg', 'laat', 'duur', 'goedkoop',
                'blij', 'boos', 'gelukkig', 'verdrietig', 'bang', 'trots',
                'makkelijk', 'moeilijk', 'gemakkelijk', 'belangrijk', 'nuttig',
                'leuk', 'saai', 'interessant', 'grappig', 'ernstig',
                'zwart', 'wit', 'rood', 'blauw', 'groen', 'geel', 'oranje',
                'veel', 'weinig', 'meer', 'minder', 'eigen', 'ander', 'zelfde',
                'verschillend', 'bepaald', 'speciaal', 'algemeen', 'gewoon', 'normaal',
                'offici√´le', 'betaald', 'beroemd', 'goede', 'diverse', 'ondertitelde',
                'verschillende', 'gemakkelijker', 'moeilijker', 'ontbrekende', 'bovengenoemde'
            ];

            if (commonAdjectives.includes(dutchWord)) {
                return 'adj.';
            }

            // Ê£ÄÊü•Ëã±ÊñáÊòØÂê¶ÊòØÂΩ¢ÂÆπËØçÊ®°Âºè
            const adjPatterns = ['good', 'bad', 'big', 'small', 'new', 'old', 'high', 'low', 'fast', 'slow',
                                'happy', 'sad', 'easy', 'difficult', 'important', 'different', 'special',
                                'general', 'official', 'famous', 'paid', 'missing', 'above-mentioned'];
            if (adjPatterns.some(pattern => englishWord === pattern || englishWord.startsWith(pattern + ' '))) {
                return 'adj.';
            }

            // 3. Âä®ËØçÂà§Êñ≠ - ÈúÄË¶ÅÊéíÈô§ÂêçËØçÂ§çÊï∞
            if (englishWord.startsWith('to ') || englishWord.match(/^to\s+\w+/)) {
                return 'v.';
            }

            // Ëç∑ÂÖ∞ËØ≠Âä®ËØçÈÄöÂ∏∏‰ª•-enÁªìÂ∞æÔºå‰ΩÜÈúÄË¶ÅÊéíÈô§‰∏Ä‰∫õÊÉÖÂÜµ
            if (dutchWord.endsWith('en')) {
                // ÊéíÈô§ÂêçËØçÂ§çÊï∞ÂíåÁâπÂÆöÂêçËØç
                const nounPluralExceptions = ['kinderen', 'mensen', 'vrienden', 'boeken', 'huizen',
                                            'landen', 'steden', 'dagen', 'weken', 'jaren', 'ogen', 'oren',
                                            'woorden', 'oefeningen', 'liedjes', 'woordenboeken', 'artikelen',
                                            'onderwerpen', 'websites', 'spelletjes', 'video\'s'];
                const adjectiveEndings = ['verschillen', 'eigen'];  // ‰∏Ä‰∫õ‰ª•-enÁªìÂ∞æÁöÑÂΩ¢ÂÆπËØç

                if (!nounPluralExceptions.includes(dutchWord) && !adjectiveEndings.includes(dutchWord)) {
                    return 'v.';
                }
            }

            // Êï∞ËØçÂà§Êñ≠
            if (/^\d+$/.test(dutchWord) ||
                ['een', 'twee', 'drie', 'vier', 'vijf', 'zes', 'zeven', 'acht', 'negen', 'tien',
                 'eerste', 'tweede', 'derde', 'vierde', 'vijfde'].includes(dutchWord)) {
                return 'num.';
            }

            // 4. ÈªòËÆ§‰∏∫ÂêçËØç - ‰ΩÜÈúÄË¶ÅÁ≤æÁ°ÆÂà§Êñ≠
            // ‰∏çÊòØÂÖ∂‰ªñËØçÊÄßÁöÑÂ∞±ÊòØÂêçËØç
            return 'n.';
        }

        // ÂàõÂª∫ÂçïËØçÂç°Áâá
        function createWordCard(word) {
            const card = document.createElement('div');
            card.className = 'word-card';
            if (learnedWords.has(word.dutch)) {
                card.classList.add('learned');
            }

            const wordType = getWordTypeTag(word);
            const englishWithType = `<span style="color: #999; font-style: italic;">${wordType}</span> ${word.english}`;

            // ÁîüÊàêÈ¢ùÂ§ñÁöÑËØ≠Ê≥ï‰ø°ÊÅØ
            let grammarInfo = '';

            // Â¶ÇÊûúÊòØÂä®ËØçÔºåÊòæÁ§∫Âü∫Êú¨Âèò‰ΩçÔºàÂè™ÊòæÁ§∫Áé∞Âú®Êó∂Ôºâ
            if (wordType === 'v.' && word.dutch.endsWith('en')) {
                const conjugations = generateVerbConjugations(word.dutch);
                if (conjugations && conjugations.length > 0) {
                    // ÊòæÁ§∫Áé∞Âú®Êó∂ÁöÑ ik/jij/wij ÂΩ¢Âºè
                    grammarInfo = `<div style="font-size: 12px; color: #667eea; margin-top: 5px;">
                        ik ${conjugations[0].present} / jij ${conjugations[1].present} / wij ${conjugations[3].present}
                    </div>`;
                }
            }
            // Â¶ÇÊûúÊòØÂêçËØçÔºåÊòæÁ§∫ÂÜ†ËØçÂíåÂ§çÊï∞
            else if (wordType === 'n.') {
                const nounInfo = generateNounInfo(word.dutch);
                if (nounInfo) {
                    grammarInfo = `<div style="font-size: 12px; color: #667eea; margin-top: 5px;">
                        ${nounInfo.article} ${word.dutch} | Â§çÊï∞: ${nounInfo.plural || word.dutch}
                    </div>`;
                }
            }

            card.innerHTML = `
                ${SpeechManager.isSupported() ? '<button class="speak-btn" title="ÂèëÈü≥">üîä</button>' : ''}
                <button class="more-btn" title="Êõ¥Â§ö‰ø°ÊÅØ">‚ãØ</button>
                <div class="theme-tag">‰∏ªÈ¢ò ${word.theme}</div>
                <div class="dutch-word">${word.dutch}</div>
                <div class="english-meaning">${englishWithType}</div>
                ${grammarInfo}
            `;

            // ÂèëÈü≥ÊåâÈíÆ‰∫ã‰ª∂
            const speakBtn = card.querySelector('.speak-btn');
            if (speakBtn) {
                speakBtn.onclick = function(e) {
                    e.stopPropagation();
                    SpeechManager.speak(word.dutch);
                };
            }

            // Êõ¥Â§öÊåâÈíÆ‰∫ã‰ª∂
            const moreBtn = card.querySelector('.more-btn');
            if (moreBtn) {
                moreBtn.onclick = function(e) {
                    e.stopPropagation();
                    showDetailModal(word);
                };
            }

            // Âç°ÁâáÁÇπÂáª‰∫ã‰ª∂ - ÁøªËΩ¨ÊòæÁ§∫
            card.onclick = function(e) {
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂèëÈü≥ÊåâÈíÆÊàñÊõ¥Â§öÊåâÈíÆÔºå‰∏çÊâßË°åÈªòËÆ§Êìç‰Ωú
                if (e.target.classList.contains('speak-btn') || e.target.classList.contains('more-btn')) return;

                // ÂàáÊç¢ÁøªËΩ¨Áä∂ÊÄÅ
                card.classList.toggle('flipped');
            };

            return card;
        }

        // ÊòæÁ§∫ÂàóË°®
        function displayList(words) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            words.forEach(word => {
                const wordType = getWordTypeTag(word);

                // ÁîüÊàêËØ≠Ê≥ï‰ø°ÊÅØ
                let grammarInfo = '';
                if (wordType === 'v.' && word.dutch.endsWith('en')) {
                    const conjugations = generateVerbConjugations(word.dutch);
                    if (conjugations && conjugations.length > 0) {
                        // Âè™ÊòæÁ§∫Áé∞Âú®Êó∂
                        grammarInfo = `<br><small style="color: #667eea;">ik ${conjugations[0].present} / jij ${conjugations[1].present} / wij ${conjugations[3].present}</small>`;
                    }
                } else if (wordType === 'n.') {
                    const nounInfo = generateNounInfo(word.dutch);
                    if (nounInfo) {
                        grammarInfo = `<br><small style="color: #667eea;">${nounInfo.article} ${word.dutch}, pl: ${nounInfo.plural}</small>`;
                    }
                }

                const row = document.createElement('tr');

                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊéåÊè°
                const isLearned = learnedWords.has(word.dutch);
                if (isLearned) {
                    row.style.backgroundColor = '#f0f8f0';
                }

                row.innerHTML = `
                    <td><strong>${word.dutch}</strong>${grammarInfo}</td>
                    <td><span style="color: #999; font-style: italic;">${wordType}</span> ${word.english}</td>
                    <td style="text-align: center;">
                        <button class="more-btn" onclick="showDetailModal({dutch: '${word.dutch.replace(/'/g, "\\'")}', english: '${word.english.replace(/'/g, "\\'")}', theme: ${word.theme}, task: ${word.task || 1}})" title="Êõ¥Â§ö‰ø°ÊÅØ">‚ãØ</button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }
        
        // ÁøªËØëÂçï‰∏™Âè•Â≠ê
        async function translateSentence(text) {
            try {
                // ‰ΩøÁî®Google Translate API
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const translateUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=nl&tl=en&dt=t&q=${encodeURIComponent(text)}`;

                const response = await fetch(proxyUrl + encodeURIComponent(translateUrl));
                if (response.ok) {
                    const data = await response.json();
                    if (data && data[0] && data[0][0] && data[0][0][0]) {
                        return data[0][0][0];
                    }
                }
            } catch (error) {
                console.log('Translation failed for sentence:', error);
            }

            // Â§áÁî®ÔºöMyMemory API
            try {
                const myMemoryUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=nl|en`;
                const response = await fetch(myMemoryUrl);
                if (response.ok) {
                    const data = await response.json();
                    if (data.responseData && data.responseData.translatedText) {
                        return data.responseData.translatedText;
                    }
                }
            } catch (error) {
                console.log('MyMemory translation failed:', error);
            }

            return null;
        }

        // ‰ªéÂ§ö‰∏™ËØçÂÖ∏Ê∫êËé∑ÂèñËØçÊ±áÊï∞ÊçÆ
        async function fetchWiktionaryData(word) {
            const result = {
                hasOnlineData: false,
                wordType: '',
                conjugations: [],
                examples: [],
                etymology: '',
                relatedWords: [],
                definitions: []
            };

            // Á≠ñÁï•1: ‰ªéTatoebaËé∑ÂèñÁúüÂÆû‰æãÂè•
            try {
                const tatoebaUrl = `https://tatoeba.org/en/api_v0/search?from=nld&query=${encodeURIComponent(word.dutch)}&to=eng`;
                const proxyUrl = 'https://api.allorigins.win/raw?url=';

                const tatoebaResponse = await fetch(proxyUrl + encodeURIComponent(tatoebaUrl));
                if (tatoebaResponse.ok) {
                    const tatoebaData = await tatoebaResponse.json();

                    if (tatoebaData && tatoebaData.results) {
                        // ÊèêÂèñÂâç5‰∏™‰æãÂè•
                        const sentences = tatoebaData.results.slice(0, 5);
                        for (const sentence of sentences) {
                            if (sentence.text && sentence.text.toLowerCase().includes(word.dutch.toLowerCase())) {
                                // Êü•ÊâæÁøªËØë
                                let translation = '';
                                if (sentence.translations) {
                                    for (const trans of sentence.translations) {
                                        if (trans.lang === 'eng') {
                                            translation = trans.text;
                                            break;
                                        }
                                    }
                                }

                                // Â¶ÇÊûúÊ≤°ÊúâÁøªËØëÔºåÂ∞ùËØïËá™Âä®ÁøªËØë
                                if (!translation) {
                                    translation = await translateSentence(sentence.text);
                                }

                                result.examples.push({
                                    dutch: sentence.text,
                                    english: translation || '(ÁøªËØëÊöÇÊó†)'
                                });
                                result.hasOnlineData = true;
                            }
                        }
                    }
                }
            } catch (err) {
                console.log('Tatoeba fetch failed:', err);
            }

            // Á≠ñÁï•2: ‰ªéGlosbeËØçÂÖ∏Ëé∑ÂèñÊï∞ÊçÆ
            try {
                const glosbeUrl = `https://api.glosbe.com/api/translate/nl/en/${encodeURIComponent(word.dutch)}`;
                const proxyUrl = 'https://api.allorigins.win/raw?url=';

                const glosbeResponse = await fetch(proxyUrl + encodeURIComponent(glosbeUrl));
                if (glosbeResponse.ok) {
                    const glosbeData = await glosbeResponse.json();

                    if (glosbeData && glosbeData.examples) {
                        // Ëé∑Âèñ‰æãÂè•
                        for (const example of glosbeData.examples.slice(0, 3)) {
                            if (example.first && example.second) {
                                result.examples.push({
                                    dutch: example.first,
                                    english: example.second
                                });
                                result.hasOnlineData = true;
                            }
                        }
                    }

                    // Ëé∑ÂèñÂÆö‰πâ
                    if (glosbeData && glosbeData.tuc) {
                        for (const tuc of glosbeData.tuc.slice(0, 3)) {
                            if (tuc.meanings) {
                                for (const meaning of tuc.meanings) {
                                    if (meaning.text) {
                                        result.definitions.push(meaning.text);
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (err) {
                console.log('Glosbe fetch failed:', err);
            }

            // Á≠ñÁï•3: ‰ªéLingueeËé∑Âèñ‰æãÂè•ÔºàÈÄöËøáÁΩëÈ°µÊäìÂèñÔºâ
            try {
                const lingueeUrl = `https://www.linguee.com/dutch-english/search?source=dutch&query=${encodeURIComponent(word.dutch)}`;
                const proxyUrl = 'https://api.allorigins.win/raw?url=';

                const lingueeResponse = await fetch(proxyUrl + encodeURIComponent(lingueeUrl));
                if (lingueeResponse.ok) {
                    const html = await lingueeResponse.text();

                    // ÁÆÄÂçïÁöÑHTMLËß£ÊûêÊù•Ëé∑Âèñ‰æãÂè•
                    const exampleRegex = /<span class='tag_s'>([^<]+)<\/span>.*?<span class='tag_t'>([^<]+)<\/span>/g;
                    let match;
                    let count = 0;

                    while ((match = exampleRegex.exec(html)) !== null && count < 3) {
                        if (match[1].toLowerCase().includes(word.dutch.toLowerCase())) {
                            result.examples.push({
                                dutch: match[1].trim(),
                                english: match[2].trim()
                            });
                            result.hasOnlineData = true;
                            count++;
                        }
                    }
                }
            } catch (err) {
                console.log('Linguee fetch failed:', err);
            }

            // Á≠ñÁï•4: Â¶ÇÊûúÊ≤°ÊúâËé∑ÂèñÂà∞‰æãÂè•ÔºåÂ∞ùËØï‰ΩøÁî®ÁÆÄÂçïÁöÑÊêúÁ¥¢ÁîüÊàê‰æãÂè•
            if (result.examples.length === 0) {
                // Â∞ùËØïÁîüÊàêÂü∫Êú¨ÁöÑ‰æãÂè•Âπ∂ÁøªËØë
                const contextualExamples = generateContextualExamples(word);

                // Â¶ÇÊûúÁîüÊàêÁöÑ‰æãÂè•Ê≤°ÊúâÁøªËØëÔºåÂ∞ùËØïÁøªËØëÂÆÉ‰ª¨
                for (const example of contextualExamples) {
                    if (!example.english || example.english === '(ÁøªËØëÊöÇÊó†)') {
                        const translation = await translateSentence(example.dutch);
                        if (translation) {
                            example.english = translation;
                        }
                    }
                    result.examples.push(example);
                }
            }

            // Á°Æ‰øùÊâÄÊúâ‰æãÂè•ÈÉΩÊúâÁøªËØë
            for (let i = 0; i < result.examples.length; i++) {
                const example = result.examples[i];
                if (typeof example === 'string') {
                    const translation = await translateSentence(example);
                    result.examples[i] = {
                        dutch: example,
                        english: translation || '(ÁøªËØëÊöÇÊó†)'
                    };
                } else if (!example.english || example.english === '(Translation not available)' || example.english === '(ÁøªËØëÊöÇÊó†)') {
                    const translation = await translateSentence(example.dutch);
                    if (translation) {
                        example.english = translation;
                    }
                }
            }

            // Â¶ÇÊûúÊòØÂä®ËØçÔºåÁîüÊàêÂèò‰Ωç
            if (word.dutch.endsWith('en')) {
                result.wordType = 'verb';
                result.conjugations = generateVerbConjugations(word.dutch);
            }

            return result;
        }

        // ÁîüÊàê‰∏ä‰∏ãÊñáÁõ∏ÂÖ≥ÁöÑ‰æãÂè•
        function generateContextualExamples(word) {
            const examples = [];

            // Âü∫‰∫éËØçÊ±áÁ±ªÂûãÁîüÊàêÊõ¥ÁúüÂÆûÁöÑ‰æãÂè•
            const templates = {
                'leren': [
                    { dutch: 'Ik wil Nederlands leren.', english: 'I want to learn Dutch.' },
                    { dutch: 'We leren nieuwe woorden elke dag.', english: 'We learn new words every day.' },
                    { dutch: 'Hij heeft veel geleerd op school.', english: 'He has learned a lot at school.' }
                ],
                'maken': [
                    { dutch: 'Ik ga een lijst maken.', english: 'I am going to make a list.' },
                    { dutch: 'Ze maakt haar huiswerk.', english: 'She is doing her homework.' },
                    { dutch: 'We hebben een fout gemaakt.', english: 'We made a mistake.' }
                ],
                'nieuws': [
                    { dutch: 'Heb je het nieuws gezien?', english: 'Did you see the news?' },
                    { dutch: 'Er is goed nieuws vandaag.', english: 'There is good news today.' },
                    { dutch: 'Ik lees het nieuws elke ochtend.', english: 'I read the news every morning.' }
                ],
                'online': [
                    { dutch: 'We werken online vandaag.', english: 'We are working online today.' },
                    { dutch: 'Je kunt het online vinden.', english: 'You can find it online.' },
                    { dutch: 'Online leren is populair.', english: 'Online learning is popular.' }
                ],
                'woorden': [
                    { dutch: 'Deze woorden zijn moeilijk.', english: 'These words are difficult.' },
                    { dutch: 'Ik ken veel Nederlandse woorden.', english: 'I know many Dutch words.' },
                    { dutch: 'Nieuwe woorden leren is leuk.', english: 'Learning new words is fun.' }
                ]
            };

            // Â¶ÇÊûúÊúâÈ¢ÑÂÆö‰πâÁöÑ‰æãÂè•Ôºå‰ΩøÁî®ÂÆÉ‰ª¨
            if (templates[word.dutch]) {
                return templates[word.dutch];
            }

            // Âê¶ÂàôÁîüÊàêÈÄöÁî®‰æãÂè•
            const genericTemplates = [
                {
                    dutch: `Wat betekent "${word.dutch}"?`,
                    english: `What does "${word.dutch}" mean?`
                },
                {
                    dutch: `Ik gebruik het woord "${word.dutch}" vaak.`,
                    english: `I use the word "${word.dutch}" often.`
                },
                {
                    dutch: `"${word.dutch}" is een belangrijk woord.`,
                    english: `"${word.dutch}" is an important word.`
                }
            ];

            return genericTemplates;
        }

        // Âú®Á∫øÊü•ËØ¢ÁºìÂ≠òÔºàÂáèÂ∞ëÈáçÂ§çËØ∑Ê±ÇÔºâ
        const grammarCache = new Map();

        // ‰ªéWiktionaryËé∑ÂèñÂáÜÁ°ÆÁöÑËØ≠Ê≥ï‰ø°ÊÅØ
        async function fetchWiktionaryData(word) {
            // Ê£ÄÊü•ÁºìÂ≠ò
            const cacheKey = `wiki_${word}`;
            if (grammarCache.has(cacheKey)) {
                console.log('‰ΩøÁî®ÁºìÂ≠òÁöÑWiktionaryÊï∞ÊçÆ');
                return grammarCache.get(cacheKey);
            }
            try {
                // Â∞ùËØï‰ªéWiktionary HTMLÈ°µÈù¢Ëé∑ÂèñÊõ¥ËØ¶ÁªÜÁöÑ‰ø°ÊÅØ
                const wikiUrl = `https://en.wiktionary.org/wiki/${encodeURIComponent(word)}`;
                const proxyUrl = 'https://api.allorigins.win/raw?url=';

                const response = await fetch(proxyUrl + encodeURIComponent(wikiUrl));
                if (response.ok) {
                    const html = await response.text();

                    // Ëß£ÊûêHTMLËé∑ÂèñËç∑ÂÖ∞ËØ≠ÈÉ®ÂàÜ
                    const dutchSection = extractDutchSection(html);
                    if (dutchSection) {
                        const result = parseDutchGrammar(dutchSection, word);
                        // ÁºìÂ≠òÊàêÂäüÁöÑÁªìÊûú
                        if (result && result.hasData) {
                            grammarCache.set(cacheKey, result);
                        }
                        return result;
                    }
                }
            } catch (error) {
                console.log('Wiktionary fetch failed:', error);
            }

            // ÁºìÂ≠òÁªìÊûúÔºàÂåÖÊã¨nullÔºâ
            grammarCache.set(cacheKey, null);
            return null;
        }

        // ‰ªéHTML‰∏≠ÊèêÂèñËç∑ÂÖ∞ËØ≠ÈÉ®ÂàÜ
        function extractDutchSection(html) {
            // Êü•ÊâæDutch section
            const dutchMatch = html.match(/<span class="mw-headline" id="Dutch">Dutch<\/span>[\s\S]*?(?=<h2>|$)/i);
            if (dutchMatch) {
                return dutchMatch[0];
            }
            return null;
        }

        // Ëß£ÊûêËç∑ÂÖ∞ËØ≠ËØ≠Ê≥ï‰ø°ÊÅØ
        function parseDutchGrammar(html, word) {
            const result = {
                hasData: false,
                conjugations: null,
                nounInfo: null,
                etymology: null
            };

            // ÊèêÂèñÂä®ËØçÂèò‰ΩçË°®
            const verbTableMatch = html.match(/<table class="inflection-table[^>]*>[\s\S]*?<\/table>/gi);
            if (verbTableMatch) {
                result.conjugations = parseVerbTable(verbTableMatch[0]);
                result.hasData = true;
            }

            // ÊèêÂèñÂêçËØçÂèòÊ†ºË°®
            const nounMatch = html.match(/\b(de|het)\s+\w+.*?plural[^<]*<[^>]*>([^<]+)</i);
            if (nounMatch) {
                result.nounInfo = {
                    article: nounMatch[1],
                    plural: nounMatch[2]
                };
                result.hasData = true;
            }

            // ÊèêÂèñËØçÊ∫ê‰ø°ÊÅØ
            const etymologyMatch = html.match(/<span[^>]*id="Etymology[^>]*>[\s\S]*?<p>([^<]+)</i);
            if (etymologyMatch) {
                result.etymology = etymologyMatch[1].replace(/<[^>]*>/g, '').trim();
            }

            return result;
        }

        // Ëß£ÊûêÂä®ËØçÂèò‰ΩçË°®
        function parseVerbTable(tableHtml) {
            const conjugations = [];

            // ÊèêÂèñË°®Ê†ºË°å
            const rows = tableHtml.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi) || [];

            rows.forEach(row => {
                // ÊèêÂèñÂçïÂÖÉÊ†ºÂÜÖÂÆπ
                const cells = row.match(/<td[^>]*>([^<]*)</gi) || [];
                if (cells.length > 0) {
                    const cleanCells = cells.map(cell =>
                        cell.replace(/<[^>]*>/g, '').trim()
                    );

                    if (cleanCells[0] && cleanCells[1]) {
                        conjugations.push({
                            person: cleanCells[0],
                            present: cleanCells[1],
                            past: cleanCells[2] || '-',
                            perfect: cleanCells[3] || '-'
                        });
                    }
                }
            });

            return conjugations.length > 0 ? conjugations : null;
        }

        // ‰ªéÂ§ö‰∏™Êù•Ê∫êËé∑ÂèñÂä®ËØçÂèò‰Ωç
        async function fetchVerbixData(verb) {
            // Ê£ÄÊü•ÁºìÂ≠ò
            const cacheKey = `verb_${verb}`;
            if (grammarCache.has(cacheKey)) {
                console.log('‰ΩøÁî®ÁºìÂ≠òÁöÑÂä®ËØçÂèò‰ΩçÊï∞ÊçÆ');
                return grammarCache.get(cacheKey);
            }

            // ÂÖàÂ∞ùËØï‰ªé‰∏Ä‰∏™ÂºÄÊîæÁöÑËç∑ÂÖ∞ËØ≠APIËé∑Âèñ
            try {
                // ‰ΩøÁî®Cooljugator APIÔºàÂÖçË¥πÁöÑÂä®ËØçÂèò‰ΩçÊúçÂä°Ôºâ
                const cooljugatorUrl = `https://cooljugator.com/nl/${encodeURIComponent(verb)}`;
                const proxyUrl = 'https://api.allorigins.win/raw?url=';

                const response = await fetch(proxyUrl + encodeURIComponent(cooljugatorUrl));
                if (response.ok) {
                    const html = await response.text();
                    const conjugations = parseCooljugatorData(html);
                    if (conjugations) {
                        console.log('‰ªéCooljugatorËé∑ÂèñÂà∞Âèò‰ΩçÊï∞ÊçÆ');
                        grammarCache.set(cacheKey, conjugations);
                        return conjugations;
                    }
                }
            } catch (error) {
                console.log('CooljugatorÊü•ËØ¢Â§±Ë¥•ÔºåÂ∞ùËØïÂÖ∂‰ªñÊù•Ê∫ê');
            }

            // Â§áÈÄâÔºöReversoConjugation
            try {
                const reversoUrl = `https://conjugator.reverso.net/conjugation-dutch-verb-${encodeURIComponent(verb)}.html`;
                const proxyUrl = 'https://api.allorigins.win/raw?url=';

                const response = await fetch(proxyUrl + encodeURIComponent(reversoUrl));
                if (response.ok) {
                    const html = await response.text();
                    const conjugations = parseReversoData(html);
                    if (conjugations) {
                        console.log('‰ªéReversoËé∑ÂèñÂà∞Âèò‰ΩçÊï∞ÊçÆ');
                        grammarCache.set(cacheKey, conjugations);
                        return conjugations;
                    }
                }
            } catch (error) {
                console.log('ReversoÊü•ËØ¢Â§±Ë¥•');
            }

            return null;
        }

        // Ëß£ÊûêCooljugatorÊï∞ÊçÆ
        function parseCooljugatorData(html) {
            try {
                // Êü•ÊâæÁé∞Âú®Êó∂Âèò‰Ωç
                const presentMatch = html.match(/Present[\s\S]*?<div class="conjugation-table"[^>]*>([\s\S]*?)<\/div>/i);
                if (!presentMatch) return null;

                const conjugations = [];
                const persons = ['ik', 'jij/je', 'hij/zij/het', 'wij/we', 'jullie', 'zij/ze'];

                // ÊèêÂèñÊØè‰∏™‰∫∫Áß∞ÁöÑÂèò‰Ωç
                const forms = presentMatch[1].match(/<span class="conjugated-verb"[^>]*>([^<]+)<\/span>/gi);
                if (forms && forms.length >= 6) {
                    forms.slice(0, 6).forEach((form, i) => {
                        const cleanForm = form.replace(/<[^>]*>/g, '').trim();
                        conjugations.push({
                            person: persons[i],
                            present: cleanForm,
                            past: '-',
                            perfect: '-'
                        });
                    });
                    return conjugations;
                }
            } catch (error) {
                console.log('Ëß£ÊûêCooljugatorÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
            return null;
        }

        // Ëß£ÊûêReversoÊï∞ÊçÆ
        function parseReversoData(html) {
            try {
                // Êü•ÊâæÁé∞Âú®Êó∂Âå∫Âüü
                const presentSection = html.match(/Indicatief[\s\S]*?Onvoltooid tegenwoordige tijd([\s\S]*?)Onvoltooid verleden tijd/i);
                if (!presentSection) return null;

                const conjugations = [];
                const persons = ['ik', 'jij/je', 'hij/zij/het', 'wij/we', 'jullie', 'zij/ze'];

                // ÊèêÂèñÂä®ËØçÂΩ¢Âºè
                const verbForms = presentSection[1].match(/<i[^>]*>([^<]+)<\/i>/gi);
                if (verbForms && verbForms.length >= 6) {
                    verbForms.slice(0, 6).forEach((form, i) => {
                        const cleanForm = form.replace(/<[^>]*>/g, '').trim();
                        conjugations.push({
                            person: persons[i],
                            present: cleanForm,
                            past: '-',
                            perfect: '-'
                        });
                    });
                    return conjugations;
                }
            } catch (error) {
                console.log('Ëß£ÊûêReversoÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
            return null;
        }

        // Ëß£ÊûêVerbixËøîÂõûÁöÑÂèò‰ΩçÊï∞ÊçÆ
        function parseVerbixConjugations(html) {
            const conjugations = [];

            // ÊèêÂèñÁé∞Âú®Êó∂
            const presentMatch = html.match(/Present[\s\S]*?<table[^>]*>([\s\S]*?)<\/table>/i);
            if (presentMatch) {
                const presentForms = extractVerbForms(presentMatch[1]);
                if (presentForms.length >= 6) {
                    const persons = ['ik', 'jij/je', 'hij/zij/het', 'wij/we', 'jullie', 'zij/ze'];
                    persons.forEach((person, i) => {
                        conjugations.push({
                            person: person,
                            present: presentForms[i] || '-',
                            past: '-',
                            perfect: '-'
                        });
                    });
                }
            }

            return conjugations.length > 0 ? conjugations : null;
        }

        // ÊèêÂèñÂä®ËØçÂΩ¢Âºè
        function extractVerbForms(html) {
            const forms = [];
            const matches = html.match(/<td[^>]*>([^<]+)<\/td>/gi);
            if (matches) {
                matches.forEach(match => {
                    const form = match.replace(/<[^>]*>/g, '').trim();
                    if (form && !form.includes('ik') && !form.includes('jij')) {
                        forms.push(form);
                    }
                });
            }
            return forms;
        }

        // ÁîüÊàêÂä®ËØçÂèò‰ΩçË°®Ê†ºÊï∞ÊçÆ
        // Âü∫‰∫éËç∑ÂÖ∞ËØ≠ËØ≠Ê≥ïËßÑÂàô (Êù•Ê∫ê: dutchgrammar.com, learndutch.org)
        function generateVerbConjugations(verb) {
            // ‰∏çËßÑÂàôÂä®ËØçÊï∞ÊçÆÂ∫ì - Âü∫‰∫éÊùÉÂ®ÅËØ≠Ê≥ïÊù•Ê∫ê
            const irregularVerbs = {
                'zijn': {
                    present: ['ben', 'bent', 'is', 'zijn', 'zijn', 'zijn'],
                    past: ['was', 'was', 'was', 'waren', 'waren', 'waren'],
                    perfect: 'geweest',
                    auxiliary: 'zijn'
                },
                'hebben': {
                    present: ['heb', 'hebt', 'heeft', 'hebben', 'hebben', 'hebben'],
                    past: ['had', 'had', 'had', 'hadden', 'hadden', 'hadden'],
                    perfect: 'gehad',
                    auxiliary: 'hebben'
                },
                'gaan': {
                    present: ['ga', 'gaat', 'gaat', 'gaan', 'gaan', 'gaan'],
                    past: ['ging', 'ging', 'ging', 'gingen', 'gingen', 'gingen'],
                    perfect: 'gegaan',
                    auxiliary: 'zijn'
                },
                'doen': {
                    present: ['doe', 'doet', 'doet', 'doen', 'doen', 'doen'],
                    past: ['deed', 'deed', 'deed', 'deden', 'deden', 'deden'],
                    perfect: 'gedaan',
                    auxiliary: 'hebben'
                },
                'komen': {
                    present: ['kom', 'komt', 'komt', 'komen', 'komen', 'komen'],
                    past: ['kwam', 'kwam', 'kwam', 'kwamen', 'kwamen', 'kwamen'],
                    perfect: 'gekomen',
                    auxiliary: 'zijn'
                },
                'zien': {
                    present: ['zie', 'ziet', 'ziet', 'zien', 'zien', 'zien'],
                    past: ['zag', 'zag', 'zag', 'zagen', 'zagen', 'zagen'],
                    perfect: 'gezien',
                    auxiliary: 'hebben'
                },
                // ÊÉÖÊÄÅÂä®ËØç (Êù•Ê∫ê: dutchgrammar.com)
                'kunnen': {
                    present: ['kan', 'kunt/kan', 'kan', 'kunnen', 'kunnen', 'kunnen'],
                    past: ['kon', 'kon', 'kon', 'konden', 'konden', 'konden'],
                    perfect: 'gekund',
                    auxiliary: 'hebben'
                },
                'moeten': {
                    present: ['moet', 'moet', 'moet', 'moeten', 'moeten', 'moeten'],
                    past: ['moest', 'moest', 'moest', 'moesten', 'moesten', 'moesten'],
                    perfect: 'gemoeten',
                    auxiliary: 'hebben'
                },
                'mogen': {
                    present: ['mag', 'mag', 'mag', 'mogen', 'mogen', 'mogen'],
                    past: ['mocht', 'mocht', 'mocht', 'mochten', 'mochten', 'mochten'],
                    perfect: 'gemogen',
                    auxiliary: 'hebben'
                },
                'willen': {
                    present: ['wil', 'wilt/wil', 'wil', 'willen', 'willen', 'willen'],
                    past: ['wilde', 'wilde', 'wilde', 'wilden', 'wilden', 'wilden'],
                    perfect: 'gewild',
                    auxiliary: 'hebben'
                },
                'zullen': {
                    present: ['zal', 'zult/zal', 'zal', 'zullen', 'zullen', 'zullen'],
                    past: ['zou', 'zou', 'zou', 'zouden', 'zouden', 'zouden'],
                    perfect: '-',
                    auxiliary: '-'
                },
                // ÂÖ∂‰ªñÂ∏∏ËßÅ‰∏çËßÑÂàôÂä®ËØç
                'staan': {
                    present: ['sta', 'staat', 'staat', 'staan', 'staan', 'staan'],
                    past: ['stond', 'stond', 'stond', 'stonden', 'stonden', 'stonden'],
                    perfect: 'gestaan',
                    auxiliary: 'hebben'
                },
                'slaan': {
                    present: ['sla', 'slaat', 'slaat', 'slaan', 'slaan', 'slaan'],
                    past: ['sloeg', 'sloeg', 'sloeg', 'sloegen', 'sloegen', 'sloegen'],
                    perfect: 'geslagen',
                    auxiliary: 'hebben'
                },
                'geven': {
                    present: ['geef', 'geeft', 'geeft', 'geven', 'geven', 'geven'],
                    past: ['gaf', 'gaf', 'gaf', 'gaven', 'gaven', 'gaven'],
                    perfect: 'gegeven',
                    auxiliary: 'hebben'
                },
                'nemen': {
                    present: ['neem', 'neemt', 'neemt', 'nemen', 'nemen', 'nemen'],
                    past: ['nam', 'nam', 'nam', 'namen', 'namen', 'namen'],
                    perfect: 'genomen',
                    auxiliary: 'hebben'
                },
                'maken': {
                    present: ['maak', 'maakt', 'maakt', 'maken', 'maken', 'maken'],
                    past: ['maakte', 'maakte', 'maakte', 'maakten', 'maakten', 'maakten'],
                    perfect: 'gemaakt',
                    auxiliary: 'hebben'
                },
                'leren': {
                    present: ['leer', 'leert', 'leert', 'leren', 'leren', 'leren'],
                    past: ['leerde', 'leerde', 'leerde', 'leerden', 'leerden', 'leerden'],
                    perfect: 'geleerd',
                    auxiliary: 'hebben'
                }
            };

            const persons = ['ik', 'jij/je', 'hij/zij/het', 'wij/we', 'jullie', 'zij/ze'];

            // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰∏çËßÑÂàôÂä®ËØç
            if (irregularVerbs[verb]) {
                const irregular = irregularVerbs[verb];
                return persons.map((person, i) => ({
                    person: person,
                    present: irregular.present[i],
                    past: irregular.past[i],
                    perfect: `${irregular.auxiliary === 'zijn' ? ['ben', 'bent', 'is', 'zijn', 'zijn', 'zijn'][i] : ['heb', 'hebt', 'heeft', 'hebben', 'hebben', 'hebben'][i]} ${irregular.perfect}`
                }));
            }

            // ËßÑÂàôÂä®ËØçÂèò‰Ωç (Âü∫‰∫é dutchgrammar.com ËßÑÂàô)
            const stem = verb.endsWith('en') ? verb.slice(0, -2) : verb;

            // Â§ÑÁêÜÁâπÊÆäËØçÂπ≤ËßÑÂàô
            let modifiedStem = stem;
            let pastStem = stem;
            let perfectStem = stem;

            // ËßÑÂàô1: ËØçÂπ≤‰ª• -t ÁªìÂ∞æÔºåjij/hij ÂΩ¢Âºè‰∏çÂÜçÂä† -t
            const endsWithT = stem.endsWith('t');

            // ËßÑÂàô2: ËØçÂπ≤‰ª• -v Êàñ -z ÁªìÂ∞æÔºåÂú®ËØçÂ∞æË¶ÅÂèòÊàê -f Âíå -s
            if (stem.endsWith('v')) {
                modifiedStem = stem.slice(0, -1) + 'f';
            } else if (stem.endsWith('z')) {
                modifiedStem = stem.slice(0, -1) + 's';
            }

            // ËßÑÂàô3: 't kofschip' ËßÑÂàô - ÂÜ≥ÂÆöËøáÂéªÊó∂‰ΩøÁî® -te/-de
            const kofschip = ['t', 'k', 'o', 'f', 's', 'c', 'h', 'i', 'p'];
            const lastLetter = stem.slice(-1);
            const useT = kofschip.includes(lastLetter) || stem.endsWith('ch');

            // ËßÑÂàô4: ÂèåÂÖÉÈü≥ËßÑÂàô (Â¶Ç maken -> maak)
            // Â∑≤ÁªèÂú®stem‰∏≠Â§ÑÁêÜ

            // ËøîÂõûËßÑÂàôÂä®ËØçÁöÑÂèò‰Ωç
            const jijForm = endsWithT ? stem : `${stem}t`;

            return [
                { person: 'ik', present: modifiedStem, past: `${pastStem}${useT ? 'te' : 'de'}`, perfect: `heb ge${perfectStem}${useT ? 't' : 'd'}` },
                { person: 'jij/je', present: jijForm, past: `${pastStem}${useT ? 'te' : 'de'}`, perfect: `hebt ge${perfectStem}${useT ? 't' : 'd'}` },
                { person: 'hij/zij/het', present: jijForm, past: `${pastStem}${useT ? 'te' : 'de'}`, perfect: `heeft ge${perfectStem}${useT ? 't' : 'd'}` },
                { person: 'wij/we', present: verb, past: `${pastStem}${useT ? 'ten' : 'den'}`, perfect: `hebben ge${perfectStem}${useT ? 't' : 'd'}` },
                { person: 'jullie', present: verb, past: `${pastStem}${useT ? 'ten' : 'den'}`, perfect: `hebben ge${perfectStem}${useT ? 't' : 'd'}` },
                { person: 'zij/ze', present: verb, past: `${pastStem}${useT ? 'ten' : 'den'}`, perfect: `hebben ge${perfectStem}${useT ? 't' : 'd'}` }
            ];
        }

        // ÁîüÊàêÂΩ¢ÂÆπËØçÊØîËæÉÁ∫ßÂíåÊúÄÈ´òÁ∫ß
        function generateComparativeForms(adjective) {
            // Â∏∏ËßÅ‰∏çËßÑÂàôÂΩ¢ÂÆπËØç
            const irregular = {
                'goed': { comparative: 'beter', superlative: 'best' },
                'veel': { comparative: 'meer', superlative: 'meest' },
                'weinig': { comparative: 'minder', superlative: 'minst' },
                'graag': { comparative: 'liever', superlative: 'liefst' }
            };

            if (irregular[adjective]) {
                return irregular[adjective];
            }

            // ËßÑÂàôÂΩ¢ÂÆπËØç
            // ÂçïÈü≥ËäÇÔºöÂä† -er Âíå -st
            // Â§öÈü≥ËäÇÔºöÁî® meer Âíå meest
            const syllables = adjective.split(/[aeiou]/i).length - 1;

            if (syllables <= 2) {
                return {
                    comparative: adjective + 'er',
                    superlative: adjective + 'st'
                };
            } else {
                return {
                    comparative: 'meer ' + adjective,
                    superlative: 'meest ' + adjective
                };
            }
        }

        // ÁîüÊàêÂêçËØç‰ø°ÊÅØÔºàÂÜ†ËØçÂíåÂ§çÊï∞Ôºâ
        // Âü∫‰∫éËç∑ÂÖ∞ËØ≠ËØ≠Ê≥ïËßÑÂàô (Êù•Ê∫ê: dutchgrammar.com)
        function generateNounInfo(noun) {
            // hetËØçÊ±áÊï∞ÊçÆÂ∫ì - Âü∫‰∫éÂ∏∏ËßÅËßÑÂæã
            // Á∫¶25%ÁöÑËç∑ÂÖ∞ËØ≠ÂêçËØç‰ΩøÁî®het
            const hetNouns = {
                // Âü∫Á°ÄËØçÊ±á
                'kind': { plural: 'kinderen' },
                'boek': { plural: 'boeken' },
                'huis': { plural: 'huizen' },
                'jaar': { plural: 'jaren' },
                'uur': { plural: 'uren' },
                'glas': { plural: 'glazen' },
                'ei': { plural: 'eieren' },
                'probleem': { plural: 'problemen' },
                'systeem': { plural: 'systemen' },
                'museum': { plural: 'musea' },

                // -jeÁªìÂ∞æÔºàÂ∞èËØçÔºâ
                'meisje': { plural: 'meisjes' },
                'jongetje': { plural: 'jongetjes' },
                'huisje': { plural: 'huisjes' },
                'kopje': { plural: 'kopjes' },

                // ÊäΩË±°ÂêçËØç
                'leven': { plural: 'levens' },
                'werk': { plural: 'werken' },
                'ding': { plural: 'dingen' },
                'feit': { plural: 'feiten' },
                'idee': { plural: 'idee√´n' },
                'gevoel': { plural: 'gevoelens' },

                // ‰∏çÂèØÊï∞ÊàñÁâπÊÆä
                'nieuws': { plural: null }, // ‰∏çÂèØÊï∞
                'water': { plural: 'waters' }, // ÁâπÊÆäÁî®Ê≥ï
                'weer': { plural: null }, // ‰∏çÂèØÊï∞
                'verkeer': { plural: null }, // ‰∏çÂèØÊï∞

                // Â≠¶‰π†Áõ∏ÂÖ≥
                'woord': { plural: 'woorden' },
                'niveau': { plural: 'niveaus' },
                'onderwerp': { plural: 'onderwerpen' },
                'journaal': { plural: 'journaals' },
                'land': { plural: 'landen' }
            };

            // deÂêçËØçÁöÑÁâπÊÆäÂ§çÊï∞ÂΩ¢Âºè
            const deSpecialPlurals = {
                'stad': 'steden',
                'dag': 'dagen',
                'weg': 'wegen',
                'vraag': 'vragen',
                'man': 'mannen',
                'vrouw': 'vrouwen',
                'mens': 'mensen',
                'krant': 'kranten',
                'brief': 'brieven',
                'lijst': 'lijsten',
                'keer': 'keren',
                'week': 'weken',
                'maand': 'maanden',
                'letter': 'letters',
                'tafel': 'tafels',
                'winkel': 'winkels',
                'artikel': 'artikelen',
                'mogelijkheid': 'mogelijkheden'
            };

            // Ê£ÄÊü•ÊòØÂê¶ÊòØhetÂêçËØç
            if (hetNouns[noun]) {
                return {
                    article: 'het',
                    plural: hetNouns[noun].plural || noun
                };
            }

            // ËßÑÂàô1: -jeÁªìÂ∞æÔºàÊåáÂ∞èËØçÔºâÊÄªÊòØhetÔºåÂ§çÊï∞Âä†-s
            if (noun.endsWith('je')) {
                return {
                    article: 'het',
                    plural: noun + 's'
                };
            }

            // ËßÑÂàô2: Ê£ÄÊü•ÂÖ∂‰ªñhetËØçËßÑÂæã
            // Âü∫‰∫é dutchgrammar.com ÁöÑËßÑÂàô
            let article = 'de';  // ÈªòËÆ§‰∏∫de (Á∫¶75%ÁöÑÂêçËØç)

            // hetËØçËßÑÂæãÊ£ÄÊü•
            // 1. ÂèåÈü≥ËäÇËØç‰ª•be-, ge-, ver-, ont-ÂºÄÂ§¥
            if ((noun.startsWith('be') || noun.startsWith('ge') ||
                 noun.startsWith('ver') || noun.startsWith('ont')) &&
                 noun.split(/[aeiou]/i).length <= 3) {
                article = 'het';
            }
            // 2. ‰ª•-sel, -isme, -ment, -umÁªìÂ∞æ
            else if (noun.endsWith('sel') || noun.endsWith('isme') ||
                     noun.endsWith('ment') || noun.endsWith('um')) {
                article = 'het';
            }

            // Ê£ÄÊü•ÁâπÊÆäÂ§çÊï∞ÂΩ¢Âºè
            let plural = '';
            if (deSpecialPlurals[noun]) {
                plural = deSpecialPlurals[noun];
            } else {
                // Â§çÊï∞ËßÑÂàô (Âü∫‰∫é dutchgrammar.com)
                // ËßÑÂàô1: ‰ΩøÁî®-sÁöÑÊÉÖÂÜµ
                if (noun.endsWith('el') || noun.endsWith('em') || noun.endsWith('en') ||
                    noun.endsWith('er') || noun.endsWith('aar') || noun.endsWith('aard')) {
                    // ÈùûÈáçËØªÈü≥ËäÇÁªìÂ∞æ
                    plural = noun + 's';
                } else if (noun.endsWith('ie') || noun.endsWith('oe')) {
                    // ÈùûÈáçËØªÂÖÉÈü≥ÁªÑÂêà
                    plural = noun + 's';
                } else if (noun.endsWith('a') || noun.endsWith('i') || noun.endsWith('o') ||
                           noun.endsWith('u') || noun.endsWith('y')) {
                    // Âçï‰∏™ÂÖÉÈü≥ÁªìÂ∞æ
                    plural = noun + "'s";
                }
                // ËßÑÂàô2: ÁâπÊÆäÂèòÂåñ
                else if (noun.endsWith('heid')) {
                    plural = noun.replace(/heid$/, 'heden');
                } else if (noun.endsWith('f')) {
                    plural = noun.slice(0, -1) + 'ven';
                } else if (noun.endsWith('s')) {
                    plural = noun + 'sen';  // bus -> bussen
                }
                // ËßÑÂàô3: ÈªòËÆ§‰ΩøÁî®-en
                else {
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂèåÂÜôËæÖÈü≥ÔºàÁü≠ÂÖÉÈü≥+ËæÖÈü≥Ôºâ
                    const vowels = 'aeiou';
                    if (noun.length >= 3) {
                        const lastChar = noun.slice(-1);
                        const secondLast = noun.slice(-2, -1);
                        const thirdLast = noun.slice(-3, -2);

                        // Áü≠ÂÖÉÈü≥+ËæÖÈü≥ -> ÂèåÂÜôËæÖÈü≥
                        if (vowels.includes(secondLast) && !vowels.includes(lastChar) &&
                            !vowels.includes(thirdLast)) {
                            plural = noun + lastChar + 'en';  // man -> mannen
                        } else {
                            plural = noun + 'en';
                        }
                    } else {
                        plural = noun + 'en';
                    }
                }
            }

            return { article, plural };
        }

        // ÊòæÁ§∫ËØ¶ÁªÜ‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
        window.showDetailModal = async function(word) {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');

            // ÂÖàÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            modal.classList.add('active');
            content.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div style="font-size: 2em; color: #667eea; margin-bottom: 20px;">‚åõ</div>
                    <div style="color: #666;">Ê≠£Âú®Ëé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ...</div>
                    <div style="color: #999; font-size: 0.9em; margin-top: 10px;">‰ªéWiktionaryÊü•ËØ¢‰∏≠...</div>
                </div>
            `;

            // ‰ªéÂ§ö‰∏™Êù•Ê∫êËé∑ÂèñÂáÜÁ°ÆÁöÑËØ≠Ê≥ï‰ø°ÊÅØ
            let onlineData = null;
            let localData = await getWordDetails(word);

            // Â∞ùËØï‰ªéWiktionaryËé∑ÂèñÊï∞ÊçÆ
            try {
                const wikiData = await fetchWiktionaryData(word.dutch);
                if (wikiData && wikiData.hasData) {
                    onlineData = wikiData;
                    console.log('ÊàêÂäü‰ªéWiktionaryËé∑ÂèñÊï∞ÊçÆ:', wikiData);
                }
            } catch (error) {
                console.log('WiktionaryÊü•ËØ¢Â§±Ë¥•:', error);
            }

            // Â¶ÇÊûúÊòØÂä®ËØç‰∏îÊ≤°ÊúâËé∑ÂèñÂà∞Âèò‰ΩçÔºåÂ∞ùËØï‰ªéVerbixËé∑Âèñ
            if (word.dutch.endsWith('en') && (!onlineData || !onlineData.conjugations)) {
                try {
                    const verbixData = await fetchVerbixData(word.dutch);
                    if (verbixData) {
                        if (!onlineData) onlineData = { hasData: true };
                        onlineData.conjugations = verbixData;
                        console.log('ÊàêÂäü‰ªéVerbixËé∑ÂèñÂä®ËØçÂèò‰Ωç');
                    }
                } catch (error) {
                    console.log('VerbixÊü•ËØ¢Â§±Ë¥•:', error);
                }
            }

            // ÂêàÂπ∂Êï∞ÊçÆÔºöÂú®Á∫øÊï∞ÊçÆ‰ºòÂÖà
            let displayData = {
                pronunciation: (onlineData && onlineData.pronunciation) || localData.pronunciation || '',
                type: (onlineData && onlineData.type) || localData.wordType || localData.type || '',
                gender: (onlineData && onlineData.gender) || localData.gender || '',
                conjugations: (onlineData && onlineData.conjugations) || localData.conjugations || null,
                examples: localData.examples || [],
                related: localData.relatedWords || localData.related || [],
                etymology: (onlineData && onlineData.etymology) || localData.etymology || '',
                hasOnlineData: (onlineData && onlineData.hasData) || localData.hasOnlineData || false,
                nounInfo: (onlineData && onlineData.nounInfo) || null
            };

            // Âè™‰∏∫ÂêçËØçÁîüÊàêÂÜ†ËØçÂíåÂ§çÊï∞‰ø°ÊÅØ
            if (!displayData.nounInfo && !displayData.conjugations) {
                // ÈáçÊñ∞Âà§Êñ≠ËØçÊÄß
                const wordType = getWordTypeTag(word);

                // Âè™ÊúâÁ°ÆÂÆöÊòØÂêçËØçÊó∂ÊâçÁîüÊàêÂêçËØç‰ø°ÊÅØ
                if (wordType === 'n.') {
                    displayData.nounInfo = generateNounInfo(word.dutch);
                } else if (wordType === 'adj.') {
                    // ÂΩ¢ÂÆπËØç‰∏çÁîüÊàêÂÜ†ËØçÔºå‰ΩÜÂèØ‰ª•ÊòæÁ§∫ÊØîËæÉÁ∫ß
                    displayData.adjectiveInfo = {
                        type: 'adjective',
                        comparative: generateComparativeForms(word.dutch)
                    };
                }
            }

            // Ê†ºÂºèÂåñ‰æãÂè•Âπ∂ÁøªËØë
            if (displayData.hasOnlineData && displayData.examples.length > 0) {
                // Â¶ÇÊûú‰æãÂè•ÊòØÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫ÂØπË±°Ê†ºÂºèÂπ∂ÁøªËØë
                const translatedExamples = [];
                for (const ex of displayData.examples) {
                    if (typeof ex === 'string') {
                        const translation = await translateSentence(ex);
                        translatedExamples.push({
                            dutch: ex,
                            english: translation || '(ÁøªËØëËé∑Âèñ‰∏≠...)'
                        });
                    } else if (ex.english === '(ÁøªËØëÊöÇÊó†)' || ex.english === '(Translation not available)') {
                        // ÂØπ‰∫é‰πãÂâçÊ≤°ÊúâÁøªËØëÁöÑ‰æãÂè•ÔºåÂ∞ùËØïÁøªËØë
                        const translation = await translateSentence(ex.dutch);
                        translatedExamples.push({
                            dutch: ex.dutch,
                            english: translation || ex.english
                        });
                    } else {
                        translatedExamples.push(ex);
                    }
                }
                displayData.examples = translatedExamples;
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊéåÊè°
            const isLearned = learnedWords.has(word.dutch);

            content.innerHTML = `
                <div class="detail-header">
                    <div class="detail-word">${word.dutch}</div>
                    ${displayData.pronunciation ? `<div class="detail-pronunciation">[${displayData.pronunciation}]</div>` : ''}
                    <div class="detail-meaning">${word.english}</div>
                    <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                        ${SpeechManager.isSupported() ? `<button class="speak-btn" onclick="SpeechManager.speak('${word.dutch.replace(/'/g, "\\'")}')" style="position: relative; top: auto; left: auto;">üîä ÂèëÈü≥</button>` : ''}
                        <button id="masteryBtn" class="mastery-btn ${isLearned ? 'learned' : ''}"
                                style="background: ${isLearned ? '#4CAF50' : '#667eea'};
                                       color: white;
                                       border: none;
                                       padding: 8px 16px;
                                       border-radius: 20px;
                                       cursor: pointer;
                                       font-size: 14px;"
                                onclick="toggleMastery('${word.dutch}')">
                            ${isLearned ? '‚úì Â∑≤ÊéåÊè°' : 'Ê†áËÆ∞‰∏∫Â∑≤ÊéåÊè°'}
                        </button>
                    </div>
                    ${displayData.hasOnlineData ? '<div style="color: #4CAF50; font-size: 12px; margin-top: 5px;">üìö Êï∞ÊçÆÊù•Ê∫êÔºöÂú®Á∫øËØçÂÖ∏ÔºàWiktionary/Cooljugator/ReversoÔºâ</div>' : '<div style="color: #999; font-size: 12px; margin-top: 5px;">üìù Êï∞ÊçÆÊù•Ê∫êÔºöÊú¨Âú∞ËØ≠Ê≥ïËßÑÂàôÁîüÊàê</div>'}
                </div>

                <div class="detail-section">
                    <h3>Âü∫Êú¨‰ø°ÊÅØ</h3>
                    <div class="detail-info">
                        <span class="detail-tag">‰∏ªÈ¢ò ${word.theme}</span>
                        ${displayData.type ? `<span class="detail-tag">${displayData.type}</span>` : ''}
                        ${displayData.gender ? `<span class="detail-tag">${displayData.gender}</span>` : ''}
                    </div>
                </div>

                ${displayData.etymology ? `
                <div class="detail-section">
                    <h3>ËØçÊ∫ê</h3>
                    <div style="padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        ${displayData.etymology}
                    </div>
                </div>
                ` : ''}

                ${displayData.conjugations && displayData.conjugations.length > 0 ? `
                <div class="detail-section">
                    <h3>Âä®ËØçÂèò‰Ωç ${!displayData.hasOnlineData ? '<small style="color: #999; font-size: 12px;">(Âü∫‰∫é dutchgrammar.com ËßÑÂàôÁîüÊàê)</small>' : ''}</h3>
                    <table class="conjugation-table">
                        <thead>
                            <tr>
                                <th>‰∫∫Áß∞</th>
                                <th>Áé∞Âú®Êó∂</th>
                                <th>ËøáÂéªÊó∂</th>
                                <th>Áé∞Âú®ÂÆåÊàêÊó∂</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${displayData.conjugations.map(c => `
                                <tr>
                                    <td>${c.person || c.tense || ''}</td>
                                    <td>${c.present || c.conjugation || '-'}</td>
                                    <td>${c.past || '-'}</td>
                                    <td>${c.perfect || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                ${displayData.nounInfo ? `
                <div class="detail-section">
                    <h3>ÂêçËØçÂΩ¢Âºè ${!displayData.hasOnlineData ? '<small style="color: #999; font-size: 12px;">(Âü∫‰∫é dutchgrammar.com ËßÑÂàôÁîüÊàê)</small>' : ''}</h3>
                    <table class="conjugation-table">
                        <thead>
                            <tr>
                                <th>ÂÜ†ËØç</th>
                                <th>ÂçïÊï∞</th>
                                <th>Â§çÊï∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>${displayData.nounInfo.article}</strong></td>
                                <td>${word.dutch}</td>
                                <td>${displayData.nounInfo.plural}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 10px; color: #666; font-size: 14px;">
                        ÂÆåÊï¥ÂΩ¢Âºè: <strong>${displayData.nounInfo.article} ${word.dutch}</strong> (ÂçïÊï∞) | <strong>de ${displayData.nounInfo.plural}</strong> (Â§çÊï∞)
                    </div>
                </div>
                ` : ''}

                ${displayData.adjectiveInfo ? `
                <div class="detail-section">
                    <h3>ÂΩ¢ÂÆπËØçÂèòÂåñ</h3>
                    <table class="conjugation-table">
                        <thead>
                            <tr>
                                <th>ÂéüÁ∫ß</th>
                                <th>ÊØîËæÉÁ∫ß</th>
                                <th>ÊúÄÈ´òÁ∫ß</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${word.dutch}</td>
                                <td><strong>${displayData.adjectiveInfo.comparative.comparative}</strong></td>
                                <td><strong>${displayData.adjectiveInfo.comparative.superlative}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                ` : ''}

                ${displayData.examples && displayData.examples.length > 0 ? `
                <div class="detail-section">
                    <h3>‰æãÂè•</h3>
                    ${displayData.examples.map(ex => `
                        <div class="example-sentence">
                            <div class="example-dutch selectable-text">${typeof ex === 'string' ? ex : ex.dutch}</div>
                            ${typeof ex === 'object' && ex.english ?
                                `<div class="example-english selectable-text">${ex.english}</div>` :
                                ''}
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                ${displayData.related && displayData.related.length > 0 ? `
                <div class="detail-section">
                    <h3>Áõ∏ÂÖ≥ËØçÊ±á</h3>
                    <div class="detail-info">
                        ${displayData.related.map(r => `<span class="detail-tag">${r}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            modal.classList.add('active');
        }

        // ÂÖ≥Èó≠ËØ¶ÁªÜ‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
        window.closeDetailModal = function() {
            const modal = document.getElementById('detailModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // ÂàáÊç¢ÊéåÊè°Áä∂ÊÄÅ
        window.toggleMastery = function(dutchWord) {
            if (learnedWords.has(dutchWord)) {
                learnedWords.delete(dutchWord);
            } else {
                learnedWords.add(dutchWord);
            }

            // ‰øùÂ≠òÁä∂ÊÄÅ
            StorageManager.saveLearnedWords();

            // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÂêåÊ≠•Âà∞‰∫ëÁ´Ø
            if (typeof SyncManager !== 'undefined') {
                SyncManager.scheduleSave();
            }

            // Â¶ÇÊûúÂ≠¶‰π†ËÆ°ÂàíÊøÄÊ¥ªÔºåÊõ¥Êñ∞ËÆ°ÂàíÁªüËÆ°
            if (StudyPlanManager.isActive) {
                StudyPlanManager.updatePlanStats();

                // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞‰ªäÊó•ÁõÆÊ†á
                const todayWords = StudyPlanManager.dayAssignments[StudyPlanManager.currentDay] || [];
                const todayLearned = todayWords.filter(word => learnedWords.has(word)).length;

                if (todayLearned >= StudyPlanManager.wordsPerDay && !StudyPlanManager.todayCompleted) {
                    StudyPlanManager.todayCompleted = true;
                    showCompletionPopup();
                }
            }

            // Êõ¥Êñ∞ÁªüËÆ°
            updateStats();

            // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
            const btn = document.getElementById('masteryBtn');
            if (btn) {
                const isLearned = learnedWords.has(dutchWord);
                btn.className = `mastery-btn ${isLearned ? 'learned' : ''}`;
                btn.style.background = isLearned ? '#4CAF50' : '#667eea';
                btn.textContent = isLearned ? '‚úì Â∑≤ÊéåÊè°' : 'Ê†áËÆ∞‰∏∫Â∑≤ÊéåÊè°';
            }

            // Êõ¥Êñ∞Âç°ÁâáËßÜÂõæ‰∏≠ÁöÑÊ†∑Âºè
            displayVocabulary();
        }

        // Â§ÑÁêÜËØ¶ÁªÜ‰ø°ÊÅØÊ®°ÊÄÅÊ°ÜÁöÑÁÇπÂáª‰∫ã‰ª∂
        window.handleDetailModalClick = function(event) {
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊ®°ÊÄÅÊ°ÜËÉåÊôØÔºà‰∏çÊòØÂÜÖÂÆπÂå∫ÂüüÔºâÔºåÂàôÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            if (event.target === event.currentTarget) {
                closeDetailModal();
            }
        }

        // Ê∑ªÂä†ESCÈîÆÂÖ≥Èó≠ËØ¶ÁªÜ‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' || event.keyCode === 27) {
                const detailModal = document.getElementById('detailModal');
                const randomModal = document.getElementById('randomModal');

                // ‰ºòÂÖàÂÖ≥Èó≠ËØ¶ÁªÜ‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
                if (detailModal && detailModal.classList.contains('active')) {
                    closeDetailModal();
                    event.preventDefault();
                }
                // Â¶ÇÊûúËØ¶ÁªÜ‰ø°ÊÅØÊ®°ÊÄÅÊ°ÜÊ≤°ÊúâÊâìÂºÄÔºåÂàôÂÖ≥Èó≠ÈöèÊú∫Ê®°ÊÄÅÊ°Ü
                else if (randomModal && randomModal.classList.contains('active')) {
                    closeRandomModal();
                    event.preventDefault();
                }
            }
        });

        // ÈÄâËØçÁøªËØëÂäüËÉΩ
        const SelectionTranslator = {
            popup: null,
            selectedText: '',
            vocabularyMap: new Map(),
            translationCache: new Map(), // ÁºìÂ≠òÁøªËØëÁªìÊûú
            isLoading: false,

            init() {
                this.popup = document.getElementById('translationPopup');

                // ÊûÑÂª∫ËØçÊ±áÊò†Â∞ÑË°®
                vocabulary.forEach(word => {
                    this.vocabularyMap.set(word.dutch.toLowerCase(), word);
                    // ‰πüÊ∑ªÂä†‰∏Ä‰∫õÂèòÂΩ¢
                    if (word.dutch.endsWith('en')) {
                        // Âä®ËØçÁöÑ‰∏Ä‰∫õÂ∏∏ËßÅÂèòÂΩ¢
                        const stem = word.dutch.slice(0, -2);
                        this.vocabularyMap.set(stem + 't', word); // Á¨¨‰∫å/‰∏â‰∫∫Áß∞ÂçïÊï∞
                        this.vocabularyMap.set(stem + 'te', word); // ËøáÂéªÂºè
                        this.vocabularyMap.set(stem + 'ten', word); // ËøáÂéªÂºèÂ§çÊï∞
                        this.vocabularyMap.set('ge' + stem + 'd', word); // ËøáÂéªÂàÜËØç
                        this.vocabularyMap.set('ge' + stem + 't', word); // ËøáÂéªÂàÜËØç
                    }
                });

                // Ê∑ªÂä†ÊñáÊú¨ÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨
                document.addEventListener('mouseup', this.handleSelection.bind(this));
                document.addEventListener('touchend', this.handleSelection.bind(this));

                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ÂºπÁ™ó
                document.addEventListener('mousedown', (e) => {
                    if (!this.popup.contains(e.target)) {
                        this.hidePopup();
                    }
                });
            },

            // Âú®Á∫øÊü•ËØ¢ËØçÊ±á
            async queryOnline(text) {
                // ÂÖàÊ£ÄÊü•ÁºìÂ≠ò
                if (this.translationCache.has(text.toLowerCase())) {
                    return this.translationCache.get(text.toLowerCase());
                }

                try {
                    // ÊñπÊ≥ï1: ‰ΩøÁî®Google Translate API (ÈÄöËøá‰ª£ÁêÜ)
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const translateUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=nl&tl=en&dt=t&q=${encodeURIComponent(text)}`;

                    const response = await fetch(proxyUrl + encodeURIComponent(translateUrl));
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data[0] && data[0][0] && data[0][0][0]) {
                            const translation = data[0][0][0];
                            const result = {
                                dutch: text,
                                english: translation,
                                source: 'online'
                            };
                            // ÁºìÂ≠òÁªìÊûú
                            this.translationCache.set(text.toLowerCase(), result);
                            return result;
                        }
                    }
                } catch (error) {
                    console.log('Google Translate failed:', error);
                }

                // ÊñπÊ≥ï2: ‰ΩøÁî®MyMemoryÁøªËØëAPIÔºàÂÖçË¥πÔºåÊó†ÈúÄAPIÂØÜÈí•Ôºâ
                try {
                    const myMemoryUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=nl|en`;

                    const response = await fetch(myMemoryUrl);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.responseData && data.responseData.translatedText) {
                            const result = {
                                dutch: text,
                                english: data.responseData.translatedText,
                                source: 'online'
                            };
                            // ÁºìÂ≠òÁªìÊûú
                            this.translationCache.set(text.toLowerCase(), result);
                            return result;
                        }
                    }
                } catch (error) {
                    console.log('MyMemory failed:', error);
                }

                // ÊñπÊ≥ï3: ‰ΩøÁî®LibreTranslateÔºàÂºÄÊ∫êÁøªËØëAPIÔºâ
                try {
                    const libreUrl = 'https://libretranslate.de/translate';
                    const response = await fetch(libreUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            q: text,
                            source: 'nl',
                            target: 'en',
                            format: 'text'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.translatedText) {
                            const result = {
                                dutch: text,
                                english: data.translatedText,
                                source: 'online'
                            };
                            this.translationCache.set(text.toLowerCase(), result);
                            return result;
                        }
                    }
                } catch (error) {
                    console.log('LibreTranslate failed:', error);
                }

                return null;
            },

            async handleSelection(e) {
                const selection = window.getSelection();
                const text = selection.toString().trim();

                if (!text || text.length > 100 || this.isLoading) {  // ÂÖÅËÆ∏Êõ¥ÈïøÁöÑÊñáÊú¨
                    return;
                }

                // Êü•ÊâæÂåπÈÖçÁöÑËØçÊ±á
                const lowerText = text.toLowerCase();

                // 1. È¶ñÂÖàÂ∞ùËØïÊú¨Âú∞ËØçÊ±áË°®Á≤æÁ°ÆÂåπÈÖç
                const exactMatch = this.vocabularyMap.get(lowerText);
                if (exactMatch) {
                    this.selectedText = text;
                    this.showPopup(exactMatch, e);
                    return;
                }

                // 2. Â¶ÇÊûúÈÄâ‰∏≠Â§ö‰∏™ËØçÔºåÂ∞ùËØïÂåπÈÖçÊØè‰∏™ËØç
                const words = lowerText.split(/\s+/);
                if (words.length > 1 && words.length <= 3) {
                    for (const word of words) {
                        const match = this.vocabularyMap.get(word);
                        if (match) {
                            this.selectedText = word;
                            this.showPopup(match, e);
                            return;
                        }
                    }
                }

                // 3. Â∞ùËØïÂéªÈô§Â∏∏ËßÅÁöÑÂêéÁºÄËøõË°åÂåπÈÖçÔºàÊõ¥Á≤æÁ°ÆÁöÑÂèòÂΩ¢ËßÑÂàôÔºâ
                if (words.length === 1) {
                    const possibleForms = this.getPossibleBaseForms(lowerText);
                    for (const form of possibleForms) {
                        const match = this.vocabularyMap.get(form);
                        if (match) {
                            this.selectedText = text;
                            this.showPopup(match, e);
                            return;
                        }
                    }
                }

                // 4. Â¶ÇÊûúÊú¨Âú∞Ê≤°ÊâæÂà∞ÔºåËøõË°åÂú®Á∫øÊü•ËØ¢
                this.isLoading = true;
                this.showLoadingPopup(text, e);

                const onlineResult = await this.queryOnline(text);
                this.isLoading = false;

                if (onlineResult) {
                    this.selectedText = text;
                    this.showPopup(onlineResult, e);
                } else {
                    // 5. Â¶ÇÊûúÂú®Á∫øÊü•ËØ¢‰πüÂ§±Ë¥•ÔºåÂ∞ùËØïÊú¨Âú∞ÈÉ®ÂàÜÂåπÈÖç‰Ωú‰∏∫ÊúÄÂêéÊâãÊÆµ
                    for (const [key, value] of this.vocabularyMap.entries()) {
                        const regex = new RegExp(`\\b${key}\\b`, 'i');
                        if (regex.test(lowerText)) {
                            this.selectedText = text;
                            this.showPopup(value, e);
                            return;
                        }
                    }

                    // ÊòæÁ§∫Êú™ÊâæÂà∞
                    this.showNotFound(text, e);
                }
            },

            showLoadingPopup(text, event) {
                const popup = this.popup;
                const wordEl = popup.querySelector('.translation-word');
                const meaningEl = popup.querySelector('.translation-meaning');

                wordEl.textContent = text;
                meaningEl.innerHTML = '<span style="color: #999;">Ê≠£Âú®Êü•ËØ¢...</span>';

                this.positionPopup(event);
                popup.classList.add('active');
            },

            showNotFound(text, event) {
                const popup = this.popup;
                const wordEl = popup.querySelector('.translation-word');
                const meaningEl = popup.querySelector('.translation-meaning');

                wordEl.textContent = text;
                meaningEl.innerHTML = '<span style="color: #999;">Êú™ÊâæÂà∞ÁøªËØë</span>';

                this.positionPopup(event);
                popup.classList.add('active');
            },

            getPossibleBaseForms(word) {
                const forms = [];

                // Âä®ËØçÂèòÂΩ¢ËßÑÂàô
                if (word.endsWith('t')) {
                    forms.push(word.slice(0, -1) + 'en');  // speelt -> spelen
                }
                if (word.endsWith('te')) {
                    forms.push(word.slice(0, -2) + 'en');  // speelde -> spelen
                }
                if (word.endsWith('ten')) {
                    forms.push(word.slice(0, -3) + 'en');  // speelden -> spelen
                }
                if (word.startsWith('ge') && word.endsWith('d')) {
                    forms.push(word.slice(2, -1) + 'en');  // gespeeld -> spelen
                }
                if (word.startsWith('ge') && word.endsWith('t')) {
                    forms.push(word.slice(2, -1) + 'en');  // gemaakt -> maken
                }

                // ÂêçËØçÂ§çÊï∞ËßÑÂàô
                if (word.endsWith('en') && word.length > 3) {
                    forms.push(word.slice(0, -2));  // woorden -> woord
                    forms.push(word.slice(0, -1));  // boeken -> boek
                }
                if (word.endsWith('s')) {
                    forms.push(word.slice(0, -1));  // artikels -> artikel
                }

                // ÂΩ¢ÂÆπËØçÂèòÂåñ
                if (word.endsWith('e')) {
                    forms.push(word.slice(0, -1));  // goede -> goed
                }

                return forms;
            },

            showPopup(word, event) {
                const popup = this.popup;
                const wordEl = popup.querySelector('.translation-word');
                const meaningEl = popup.querySelector('.translation-meaning');

                wordEl.textContent = word.dutch;

                // Ê†πÊçÆÊù•Ê∫êÊòæÁ§∫‰∏çÂêåÁöÑÁøªËØë
                if (word.source === 'online') {
                    meaningEl.innerHTML = `${word.english} <span style="color: #4CAF50; font-size: 12px;">üì°</span>`;
                } else {
                    meaningEl.textContent = word.english;
                }

                this.positionPopup(event);
                popup.classList.add('active');

                // ‰øùÂ≠òÂΩìÂâçËØçÊ±á‰æõÂèëÈü≥‰ΩøÁî®
                popup.dataset.currentWord = word.dutch;
            },

            positionPopup(event) {
                const popup = this.popup;

                // ËÆ°ÁÆó‰ΩçÁΩÆ
                let rect;
                try {
                    rect = window.getSelection().getRangeAt(0).getBoundingClientRect();
                } catch (e) {
                    // Â¶ÇÊûúÊ≤°ÊúâselectionÔºå‰ΩøÁî®Èº†Ê†á‰ΩçÁΩÆ
                    rect = {
                        left: event.clientX,
                        top: event.clientY,
                        right: event.clientX,
                        bottom: event.clientY,
                        width: 0
                    };
                }

                let left = rect.left + rect.width / 2;
                let top = rect.top - 10;

                // Á°Æ‰øùÂºπÁ™ó‰∏ç‰ºöË∂ÖÂá∫ËßÜÂè£
                popup.style.display = 'block';
                const popupRect = popup.getBoundingClientRect();

                left = Math.min(left, window.innerWidth - popupRect.width - 10);
                left = Math.max(left, 10);

                if (top - popupRect.height < 10) {
                    top = rect.bottom + 10; // ÊòæÁ§∫Âú®ÈÄâ‰∏≠ÊñáÊú¨‰∏ãÊñπ
                } else {
                    top = top - popupRect.height; // ÊòæÁ§∫Âú®ÈÄâ‰∏≠ÊñáÊú¨‰∏äÊñπ
                }

                popup.style.left = left + 'px';
                popup.style.top = top + 'px';
            },

            hidePopup() {
                this.popup.classList.remove('active');
                this.popup.style.display = 'none';
            }
        };

        // ÂèëÈü≥ÈÄâ‰∏≠ÁöÑËØçÊ±á
        window.speakSelection = function() {
            const popup = document.getElementById('translationPopup');
            const word = popup.dataset.currentWord;
            if (word && SpeechManager.isSupported()) {
                SpeechManager.speak(word);
            }
        }

        // Ëé∑ÂèñÂçïËØçËØ¶ÁªÜ‰ø°ÊÅØ
        function getWordDetails(word) {
            // Âü∫Á°Ä‰ø°ÊÅØ
            const details = {
                pronunciation: null,
                type: null,
                gender: null,
                conjugation: null,
                examples: [],
                related: []
            };

            // Êõ¥Â•ΩÁöÑ‰æãÂè•ÁîüÊàêÁ≥ªÁªü
            const exampleDatabase = {
                // Âä®ËØç‰æãÂè•Ê®°Êùø
                verbs: {
                    'eten': [
                        { dutch: 'Ik eet een appel voor het ontbijt.', english: 'I eat an apple for breakfast.' },
                        { dutch: 'We eten vanavond bij mijn ouders.', english: 'We are eating at my parents\' tonight.' },
                        { dutch: 'Heb je al gegeten?', english: 'Have you eaten yet?' }
                    ],
                    'drinken': [
                        { dutch: 'Ik drink graag koffie in de ochtend.', english: 'I like to drink coffee in the morning.' },
                        { dutch: 'Wat wil je drinken?', english: 'What would you like to drink?' },
                        { dutch: 'Hij drinkt nooit alcohol.', english: 'He never drinks alcohol.' }
                    ],
                    'lopen': [
                        { dutch: 'Ik loop elke dag naar het werk.', english: 'I walk to work every day.' },
                        { dutch: 'De kinderen lopen in het park.', english: 'The children are walking in the park.' },
                        { dutch: 'Hoe lang moet je lopen?', english: 'How long do you have to walk?' }
                    ],
                    'werken': [
                        { dutch: 'Ik werk vijf dagen per week.', english: 'I work five days a week.' },
                        { dutch: 'Waar werk je?', english: 'Where do you work?' },
                        { dutch: 'Ze werkt als lerares.', english: 'She works as a teacher.' }
                    ],
                    'wonen': [
                        { dutch: 'Ik woon in Amsterdam.', english: 'I live in Amsterdam.' },
                        { dutch: 'Waar woon je?', english: 'Where do you live?' },
                        { dutch: 'Hij woont hier al tien jaar.', english: 'He has lived here for ten years.' }
                    ],
                    'kopen': [
                        { dutch: 'Ik moet melk kopen.', english: 'I need to buy milk.' },
                        { dutch: 'Waar heb je dat gekocht?', english: 'Where did you buy that?' },
                        { dutch: 'Ze koopt altijd biologische producten.', english: 'She always buys organic products.' }
                    ],
                    'maken': [
                        { dutch: 'Ik maak het huiswerk nu.', english: 'I\'m doing the homework now.' },
                        { dutch: 'Kan je koffie voor me maken?', english: 'Can you make coffee for me?' },
                        { dutch: 'We maken een taart voor haar verjaardag.', english: 'We\'re making a cake for her birthday.' }
                    ],
                    'gaan': [
                        { dutch: 'Ik ga naar de winkel.', english: 'I\'m going to the shop.' },
                        { dutch: 'We gaan morgen op vakantie.', english: 'We\'re going on vacation tomorrow.' },
                        { dutch: 'Ga je mee?', english: 'Are you coming along?' }
                    ],
                    'komen': [
                        { dutch: 'Ik kom uit Nederland.', english: 'I come from the Netherlands.' },
                        { dutch: 'Wanneer kom je thuis?', english: 'When are you coming home?' },
                        { dutch: 'Hij komt altijd te laat.', english: 'He always comes late.' }
                    ],
                    'hebben': [
                        { dutch: 'Ik heb twee kinderen.', english: 'I have two children.' },
                        { dutch: 'Heb je tijd?', english: 'Do you have time?' },
                        { dutch: 'We hebben honger.', english: 'We are hungry.' }
                    ],
                    'zijn': [
                        { dutch: 'Ik ben student.', english: 'I am a student.' },
                        { dutch: 'Hij is mijn broer.', english: 'He is my brother.' },
                        { dutch: 'We zijn thuis.', english: 'We are at home.' }
                    ],
                    'zeggen': [
                        { dutch: 'Wat zeg je?', english: 'What did you say?' },
                        { dutch: 'Hij zegt altijd de waarheid.', english: 'He always tells the truth.' },
                        { dutch: 'Ik zeg het nog een keer.', english: 'I\'ll say it again.' }
                    ],
                    'vragen': [
                        { dutch: 'Mag ik je iets vragen?', english: 'May I ask you something?' },
                        { dutch: 'Hij vraagt om hulp.', english: 'He\'s asking for help.' },
                        { dutch: 'Waarom vraag je dat?', english: 'Why do you ask that?' }
                    ],
                    'beginnen': [
                        { dutch: 'De les begint om 9 uur.', english: 'The class starts at 9 o\'clock.' },
                        { dutch: 'Ik begin morgen met mijn nieuwe baan.', english: 'I start my new job tomorrow.' },
                        { dutch: 'Zullen we beginnen?', english: 'Shall we start?' }
                    ],
                    'leren': [
                        { dutch: 'Ik leer Nederlands.', english: 'I\'m learning Dutch.' },
                        { dutch: 'Ze leert snel.', english: 'She learns quickly.' },
                        { dutch: 'Wat heb je vandaag geleerd?', english: 'What did you learn today?' }
                    ],
                    'spreken': [
                        { dutch: 'Spreek je Nederlands?', english: 'Do you speak Dutch?' },
                        { dutch: 'Ik spreek een beetje Engels.', english: 'I speak a little English.' },
                        { dutch: 'We spreken morgen verder.', english: 'We\'ll continue talking tomorrow.' }
                    ],
                    'default': [
                        { dutch: 'Ik moet dat {verb}.', english: 'I need to {english}.' },
                        { dutch: 'Kan je me helpen te {verb}?', english: 'Can you help me to {english}?' },
                        { dutch: 'We gaan morgen {verb}.', english: 'We are going to {english} tomorrow.' }
                    ]
                },
                // ÂêçËØç‰æãÂè•Ê®°Êùø
                nouns: {
                    'default': [
                        { dutch: 'Waar is {noun}?', english: 'Where is the {english}?' },
                        { dutch: 'Ik heb een nieuw(e) {noun_clean} nodig.', english: 'I need a new {english}.' },
                        { dutch: '{noun} is erg belangrijk.', english: 'The {english} is very important.' }
                    ]
                },
                // ÂΩ¢ÂÆπËØç‰æãÂè•Ê®°Êùø
                adjectives: {
                    'default': [
                        { dutch: 'Dit is heel {adjective}.', english: 'This is very {english}.' },
                        { dutch: 'Het wordt {adjective}.', english: 'It\'s getting {english}.' },
                        { dutch: 'Dat is niet zo {adjective}.', english: 'That\'s not so {english}.' }
                    ]
                }
            };

            // Ê£ÄÊµãËØçÊÄßÂπ∂ÁîüÊàê‰æãÂè•
            if (word.dutch.endsWith('en')) {
                details.type = 'Âä®ËØç (werkwoord)';

                // ÁîüÊàêÂü∫Êú¨ÁöÑÂä®ËØçÂèò‰Ωç
                const stem = word.dutch.slice(0, -2);

                // Êõ¥ÂáÜÁ°ÆÁöÑÂä®ËØçÂèò‰ΩçÔºàÂ§ÑÁêÜÁâπÊÆäÊÉÖÂÜµÔºâ
                const isRegular = !['hebben', 'zijn', 'kunnen', 'mogen', 'willen', 'zullen', 'gaan', 'doen'].includes(word.dutch);

                if (isRegular) {
                    details.conjugation = [
                        { person: 'ik', present: stem, past: stem + 'te', perfect: 'heb ge' + stem + 'd/t' },
                        { person: 'jij/je', present: stem + 't', past: stem + 'te', perfect: 'hebt ge' + stem + 'd/t' },
                        { person: 'hij/zij/het', present: stem + 't', past: stem + 'te', perfect: 'heeft ge' + stem + 'd/t' },
                        { person: 'wij/we', present: word.dutch, past: stem + 'ten', perfect: 'hebben ge' + stem + 'd/t' },
                        { person: 'jullie', present: word.dutch, past: stem + 'ten', perfect: 'hebben ge' + stem + 'd/t' },
                        { person: 'zij/ze', present: word.dutch, past: stem + 'ten', perfect: 'hebben ge' + stem + 'd/t' }
                    ];
                }

                // Êü•ÊâæÁâπÂÆöÂä®ËØçÁöÑ‰æãÂè•ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÈªòËÆ§Ê®°Êùø
                if (exampleDatabase.verbs[word.dutch]) {
                    details.examples = exampleDatabase.verbs[word.dutch];
                } else {
                    // ‰ΩøÁî®ÈªòËÆ§Ê®°Êùø
                    details.examples = exampleDatabase.verbs.default.map(ex => ({
                        dutch: ex.dutch.replace('{verb}', word.dutch).replace('{verb}', word.dutch),
                        english: ex.english.replace('{english}', word.english)
                    }));
                }

            } else if (word.dutch.startsWith('de ') || word.dutch.startsWith('het ')) {
                details.type = 'ÂêçËØç (zelfstandig naamwoord)';
                details.gender = word.dutch.startsWith('de ') ? 'de (ÈÄöÊÄß)' : 'het (‰∏≠ÊÄß)';

                const nounClean = word.dutch.replace(/^(de |het )/, '');

                // ‰ΩøÁî®ÂêçËØçÊ®°Êùø
                details.examples = exampleDatabase.nouns.default.map(ex => ({
                    dutch: ex.dutch
                        .replace('{noun}', word.dutch)
                        .replace('{noun_clean}', nounClean),
                    english: ex.english.replace('{english}', word.english)
                }));

            } else {
                // ÂÖ∂‰ªñËØçÊÄßÊ£ÄÊµã
                const dutchWord = word.dutch.toLowerCase();

                if (dutchWord.endsWith('lijk') || dutchWord.endsWith('ig') || dutchWord.endsWith('baar')) {
                    details.type = 'ÂΩ¢ÂÆπËØç (bijvoeglijk naamwoord)';

                    details.examples = exampleDatabase.adjectives.default.map(ex => ({
                        dutch: ex.dutch.replace('{adjective}', word.dutch),
                        english: ex.english.replace('{english}', word.english)
                    }));

                } else if (dutchWord.endsWith('heid') || dutchWord.endsWith('ing') || dutchWord.endsWith('tie')) {
                    details.type = 'ÂêçËØç (zelfstandig naamwoord)';

                    details.examples = [
                        { dutch: `De ${word.dutch} is belangrijk voor ons.`, english: `The ${word.english} is important for us.` },
                        { dutch: `Ik begrijp de ${word.dutch} niet.`, english: `I don\'t understand the ${word.english}.` }
                    ];

                } else {
                    // Âü∫‰∫é‰∏ªÈ¢òÁîüÊàêÊõ¥Áõ∏ÂÖ≥ÁöÑ‰æãÂè•
                    const themeExamples = {
                        1: [ // Âü∫Á°Ä
                            { dutch: `${word.dutch} is een basiswoord.`, english: `${word.english} is a basic word.` },
                            { dutch: `Ik gebruik ${word.dutch} vaak.`, english: `I use ${word.english} often.` }
                        ],
                        2: [ // È£üÁâ©
                            { dutch: `Ik hou van ${word.dutch}.`, english: `I like ${word.english}.` },
                            { dutch: `${word.dutch} is lekker.`, english: `${word.english} is delicious.` }
                        ],
                        6: [ // ‰∫§ÈÄö
                            { dutch: `Ik ga met ${word.dutch}.`, english: `I go by ${word.english}.` },
                            { dutch: `${word.dutch} is handig.`, english: `${word.english} is convenient.` }
                        ],
                        7: [ // ÂÅ•Â∫∑
                            { dutch: `${word.dutch} is goed voor je gezondheid.`, english: `${word.english} is good for your health.` }
                        ]
                    };

                    details.type = 'ÂÖ∂‰ªñ';
                    details.examples = themeExamples[word.theme] || [
                        { dutch: `Dit is ${word.dutch}.`, english: `This is ${word.english}.` },
                        { dutch: `Ik heb ${word.dutch} nodig.`, english: `I need ${word.english}.` }
                    ];
                }
            }

            // Ê∑ªÂä†Áõ∏ÂÖ≥ËØçÊ±áÔºàÂü∫‰∫é‰∏ªÈ¢òÔºâ
            const relatedWords = vocabulary
                .filter(w => w.theme === word.theme && w.dutch !== word.dutch)
                .slice(0, 5)
                .map(w => w.dutch);
            details.related = relatedWords;

            return details;
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÔºàÁ°Æ‰øùÊòØÂÖ®Â±ÄÂáΩÊï∞Ôºâ
        window.closeRandomModal = function() {
            const modal = document.getElementById('randomModal');
            if (modal) {
                modal.classList.remove('active');
            }

            // ÂàáÊç¢ÂõûÂç°ÁâáÊ®°ÂºèÔºåÈÅøÂÖçÈáçÊñ∞Ëß¶ÂèëÈöèÊú∫Ê®°Âºè
            currentMode = 'cards';

            // Êõ¥Êñ∞Ê®°ÂºèÊåâÈíÆÁöÑÁä∂ÊÄÅ
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === 'cards') {
                    btn.classList.add('active');
                }
            });

            // Á°Æ‰øùÊòæÁ§∫Ê≠£Á°ÆÁöÑËßÜÂõæ
            document.getElementById('cardsView').style.display = 'grid';
            document.getElementById('listView').style.display = 'none';

            // ‰øùÂ≠òÂÅèÂ•ΩËÆæÁΩÆ
            StorageManager.savePreferences();

            // ÈáçÊñ∞ÊòæÁ§∫ËØçÊ±á
            displayVocabulary();
        }

        // ÊòæÁ§∫ËææÊ†áÂÆåÊàêÂºπÁ™ó
        function showCompletionPopup() {
            const popup = document.createElement('div');
            popup.className = 'completion-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10002;
                text-align: center;
                animation: popupSlideIn 0.5s ease-out;
            `;

            popup.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">üéâ</div>
                <h2 style="margin: 0 0 10px 0; font-size: 24px;">‰ªäÊó•ÁõÆÊ†áËææÊàêÔºÅ</h2>
                <p style="margin: 10px 0; font-size: 16px; opacity: 0.95;">
                    Â§™Ê£í‰∫ÜÔºÅ‰Ω†Â∑≤ÂÆåÊàê‰ªäÂ§©ÁöÑÂ≠¶‰π†ÁõÆÊ†áÔºÅ<br>
                    Â∑≤ÊéåÊè° ${StudyPlanManager.wordsPerDay} ‰∏™ÂçïËØç
                </p>
                <div style="margin-top: 20px;">
                    <button onclick="this.parentElement.parentElement.remove()"
                            style="background: white; color: #667eea; border: none; padding: 10px 30px;
                                   border-radius: 25px; font-size: 16px; cursor: pointer; font-weight: bold;">
                        ÁªßÁª≠Âä†Ê≤π üí™
                    </button>
                </div>
            `;

            document.body.appendChild(popup);

            // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
            const style = document.createElement('style');
            style.textContent = `
                @keyframes popupSlideIn {
                    from {
                        opacity: 0;
                        transform: translate(-50%, -50%) scale(0.8);
                    }
                    to {
                        opacity: 1;
                        transform: translate(-50%, -50%) scale(1);
                    }
                }
            `;
            document.head.appendChild(style);

            // 5ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
            setTimeout(() => {
                popup.style.animation = 'popupSlideIn 0.5s ease-out reverse';
                setTimeout(() => popup.remove(), 500);
            }, 5000);
        }

        // ÂΩìÂâçÊòæÁ§∫ÁöÑÈöèÊú∫ÂçïËØçÈõÜÂêà
        let currentRandomWords = [];
        // ‰ªäÂ§©Â§ç‰π†ÁöÑÂçïËØçÊï∞
        let todayReviewedCount = 0;
        let sessionStartTime = Date.now();

        // ÊòæÁ§∫ÈöèÊú∫Â≠¶‰π†Ê®°ÊÄÅÊ°Ü
        function displayRandom(words) {
            if (words.length === 0) return;

            // ËøáÊª§ÊéâÂ∑≤ÊéåÊè°ÁöÑÂçïËØç
            const unlearnedWords = words.filter(word => !learnedWords.has(word.dutch));
            if (unlearnedWords.length === 0) {
                alert('Â§™Ê£í‰∫ÜÔºÅÊâÄÊúâÂçïËØçÈÉΩÂ∑≤ÊéåÊè°ÔºÅ');
                return;
            }

            // Áõ¥Êé•ÂºÄÂßãÈöèÊú∫Â≠¶‰π†Ôºå‰∏çÊòæÁ§∫‰∏ªÈ¢òÈÄâÊã©Âô®
            startRandomLearning(unlearnedWords);
        }

        // Áõ¥Êé•ÂºÄÂßãÈöèÊú∫Â≠¶‰π†
        function startRandomLearning(words) {
            // ÈáçÁΩÆ‰ªäÊó•Â§ç‰π†ËÆ°Êï∞
            todayReviewedCount = 0;
            sessionStartTime = Date.now();

            // ÂºÄÂßãÈöèÊú∫Â≠¶‰π†
            currentRandomWords = words;
            const modal = document.getElementById('randomModal');

            // Á°Æ‰øùÁªüËÆ°ÊòæÁ§∫ÂÖÉÁ¥†Â≠òÂú®Âπ∂ÂèØËßÅ
            const viewedDisplay = document.getElementById('viewedWordsDisplay');
            if (viewedDisplay) {
                viewedDisplay.style.display = 'block';  // Á°Æ‰øùÊòæÁ§∫
            }

            // Á°Æ‰øùÁªüËÆ°ÊòæÁ§∫ÊòØÊúÄÊñ∞ÁöÑ
            updateViewedWordsDisplay();

            showRandomWord();
            modal.classList.add('active');
        }


        // ÂΩìÂâçÈöèÊú∫ÂçïËØç
        let currentRandomWord = null;
        let isRandomCardFlipped = false;

        // ‰ªäÊó•Êü•ÁúãÁöÑÂçïËØçËøΩË∏™
        let todayViewedWords = new Set();
        let viewedWordsToday = 0;

        // Ëé∑Âèñ‰ªäÂ§©ÁöÑÊó•ÊúüÈîÆ
        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
        }

        // ÂàùÂßãÂåñ‰ªäÊó•Êü•ÁúãËÆ∞ÂΩï
        function initDailyViewedWords() {
            const todayKey = getTodayKey();
            const stored = localStorage.getItem('dailyViewedWords');

            if (stored) {
                const data = JSON.parse(stored);
                // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰ªäÂ§©ÁöÑÊï∞ÊçÆ
                if (data.date === todayKey) {
                    todayViewedWords = new Set(data.words);
                    viewedWordsToday = todayViewedWords.size;
                } else {
                    // Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÈáçÁΩÆÊï∞ÊçÆ
                    todayViewedWords = new Set();
                    viewedWordsToday = 0;
                    saveDailyViewedWords();
                }
            }
        }

        // ‰øùÂ≠ò‰ªäÊó•Êü•ÁúãËÆ∞ÂΩï
        function saveDailyViewedWords() {
            const todayKey = getTodayKey();
            const data = {
                date: todayKey,
                words: Array.from(todayViewedWords)
            };
            localStorage.setItem('dailyViewedWords', JSON.stringify(data));
        }

        // ËÆ∞ÂΩïÊü•ÁúãÁöÑÂçïËØç
        function recordViewedWord(dutchWord) {
            if (!todayViewedWords.has(dutchWord)) {
                todayViewedWords.add(dutchWord);
                viewedWordsToday = todayViewedWords.size;
                saveDailyViewedWords();
                updateViewedWordsDisplay();
            }
        }

        // Êõ¥Êñ∞Êü•ÁúãÁªüËÆ°ÊòæÁ§∫
        function updateViewedWordsDisplay() {
            const display = document.getElementById('viewedWordsDisplay');
            if (display) {
                display.textContent = `‰ªäÊó•Â∑≤Â≠¶‰π†: ${viewedWordsToday} ‰∏™ÂçïËØç`;
            }
        }

        // ÊòæÁ§∫ÈöèÊú∫ÂçïËØçÂç°Áâá
        function showRandomWord() {
            if (!currentRandomWords || currentRandomWords.length === 0) {
                currentRandomWords = getFilteredWords().filter(word => !learnedWords.has(word.dutch));
            }

            // ËøáÊª§ÊéâÂ∑≤ÊéåÊè°ÁöÑÂçïËØç
            const unlearnedWords = currentRandomWords.filter(word => !learnedWords.has(word.dutch));
            if (unlearnedWords.length === 0) {
                alert('Â§™Ê£í‰∫ÜÔºÅÂΩìÂâçËåÉÂõ¥ÂÜÖÁöÑÂçïËØçÈÉΩÂ∑≤ÊéåÊè°ÔºÅ');
                closeRandomModal();
                return;
            }

            currentRandomWord = unlearnedWords[Math.floor(Math.random() * unlearnedWords.length)];
            todayReviewedCount++;

            // ËÆ∞ÂΩïÊü•ÁúãÁöÑÂçïËØç
            recordViewedWord(currentRandomWord.dutch);

            const container = document.getElementById('randomCardContainer');
            const wordType = getWordTypeTag(currentRandomWord);
            isRandomCardFlipped = false;

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊéåÊè°
            const isLearned = learnedWords.has(currentRandomWord.dutch);

            // ÂàõÂª∫Êú™ÁøªËΩ¨ÁöÑÂç°ÁâáÔºàÂè™ÊòæÁ§∫Ëç∑ÂÖ∞ËØ≠Ôºâ
            container.innerHTML = `
                <button class="modal-close" id="modalCloseBtn" style="position: absolute; top: 20px; right: 20px; font-size: 30px; background: none; border: none; cursor: pointer; color: #999; z-index: 10001;">√ó</button>

                <div class="random-word-card ${isLearned ? 'learned' : ''}" id="currentRandomCard" onclick="flipRandomCard()" style="cursor: pointer; position: relative;">
                    ${SpeechManager.isSupported() ? `<button class="speak-btn-modal" onclick="event.stopPropagation(); SpeechManager.speak('${currentRandomWord.dutch.replace(/'/g, "\\'")}')" title="ÂèëÈü≥">üîä</button>` : ''}
                    <button class="more-btn" onclick="event.stopPropagation(); showDetailModal({dutch: '${currentRandomWord.dutch.replace(/'/g, "\\'")}', english: '${currentRandomWord.english.replace(/'/g, "\\'")}', theme: ${currentRandomWord.theme}, task: ${currentRandomWord.task || 1}})"
                            style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; color: white; font-size: 16px; display: none;"
                            title="Êõ¥Â§ö‰ø°ÊÅØ">‚ãØ</button>
                    <div class="dutch-word" style="font-size: 2.5em; margin-bottom: 20px;">${currentRandomWord.dutch}</div>
                    <div class="click-hint" style="color: rgba(255,255,255,0.7); font-size: 14px;">ÁÇπÂáªÁøªËΩ¨Êü•ÁúãÁøªËØë</div>
                    <div class="english-meaning" style="display: none;"><span style="color: rgba(255,255,255,0.8); font-style: italic;">${wordType}</span> ${currentRandomWord.english}</div>
                    <button class="mastery-btn-card" onclick="event.stopPropagation(); toggleRandomMastery()"
                            style="display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
                                   background: ${isLearned ? '#4CAF50' : '#667eea'};
                                   color: white; border: none; padding: 10px 20px;
                                   border-radius: 20px; cursor: pointer; font-size: 14px;">
                        ${isLearned ? '‚úì Â∑≤ÊéåÊè°' : 'Ê†áËÆ∞‰∏∫Â∑≤ÊéåÊè°'}
                    </button>
                </div>

                <div class="random-controls">
                    <button class="random-btn primary" id="nextWordBtn">
                        ‰∏ã‰∏Ä‰∏™ÂçïËØç (‚Üí)
                    </button>
                    <button class="random-btn secondary" id="closeBtn">
                        ÂÖ≥Èó≠ (ESC)
                    </button>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                    <div style="color: #fff; font-size: 14px; text-align: center; margin-bottom: 5px;">
                        üìö ‰ªäÊó•Â∑≤Â§ç‰π†Ôºö<span style="font-weight: bold; font-size: 16px;">${todayReviewedCount}</span> ‰∏™ÂçïËØç
                        ${StudyPlanManager.isActive && StudyPlanManager.wordsPerDay > 0 ?
                            `<span style="margin-left: 10px;">ÁõÆÊ†áÔºö${StudyPlanManager.wordsPerDay} ‰∏™</span>` : ''}
                    </div>
                    <div style="color: #999; font-size: 12px; text-align: center;">
                        Âø´Êç∑ÈîÆÔºöÁ©∫Ê†ºÁøªËΩ¨ | MÈîÆÊéåÊè° | ÊñπÂêëÈîÆÂàáÊç¢
                    </div>
                </div>
            `;
        }

        // ÁøªËΩ¨ÈöèÊú∫Âç°Áâá
        window.flipRandomCard = function() {
            const card = document.getElementById('currentRandomCard');
            const hint = card.querySelector('.click-hint');
            const meaning = card.querySelector('.english-meaning');
            const moreBtn = card.querySelector('.more-btn');
            const masteryBtn = card.querySelector('.mastery-btn-card');

            if (!isRandomCardFlipped) {
                // ÁøªËΩ¨ÊòæÁ§∫Ëã±ÊñáÂíåÊåâÈíÆ
                hint.style.display = 'none';
                meaning.style.display = 'block';
                moreBtn.style.display = 'block';
                masteryBtn.style.display = 'block';
                card.style.background = 'linear-gradient(135deg, #764ba2 0%, #667eea 100%)';
                isRandomCardFlipped = true;
            } else {
                // ÁøªËΩ¨ÈöêËóèËã±ÊñáÂíåÊåâÈíÆ
                hint.style.display = 'block';
                meaning.style.display = 'none';
                moreBtn.style.display = 'none';
                masteryBtn.style.display = 'none';
                card.style.background = '';
                isRandomCardFlipped = false;
            }
        }

        // ÂàáÊç¢ÈöèÊú∫Ê®°Âºè‰∏ãÁöÑÊéåÊè°Áä∂ÊÄÅ
        window.toggleRandomMastery = function() {
            if (!currentRandomWord) return;

            if (learnedWords.has(currentRandomWord.dutch)) {
                learnedWords.delete(currentRandomWord.dutch);
            } else {
                learnedWords.add(currentRandomWord.dutch);
            }

            StorageManager.saveLearnedWords();

            // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÂêåÊ≠•Âà∞‰∫ëÁ´Ø
            if (typeof SyncManager !== 'undefined') {
                SyncManager.scheduleSave();
            }

            // Â¶ÇÊûúÂ≠¶‰π†ËÆ°ÂàíÊøÄÊ¥ªÔºåÊõ¥Êñ∞ËÆ°ÂàíÁªüËÆ°
            if (StudyPlanManager.isActive) {
                StudyPlanManager.updatePlanStats();

                // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞‰ªäÊó•ÁõÆÊ†á
                const todayWords = StudyPlanManager.dayAssignments[StudyPlanManager.currentDay] || [];
                const todayLearned = todayWords.filter(word => learnedWords.has(word)).length;

                if (todayLearned >= StudyPlanManager.wordsPerDay && !StudyPlanManager.todayCompleted) {
                    StudyPlanManager.todayCompleted = true;
                    showCompletionPopup();
                }
            }

            updateStats();

            // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
            const btn = document.querySelector('.mastery-btn-card');
            const card = document.getElementById('currentRandomCard');
            const isLearned = learnedWords.has(currentRandomWord.dutch);

            if (btn) {
                btn.style.background = isLearned ? '#4CAF50' : '#667eea';
                btn.textContent = isLearned ? '‚úì Â∑≤ÊéåÊè°' : 'Ê†áËÆ∞‰∏∫Â∑≤ÊéåÊè°';
            }

            if (card) {
                if (isLearned) {
                    card.classList.add('learned');
                } else {
                    card.classList.remove('learned');
                }
            }

            // Âè™ÊúâÂú®ÈùûÈöèÊú∫Ê®°Âºè‰∏ãÊâçÊõ¥Êñ∞‰∏ªÁïåÈù¢
            // ÈöèÊú∫Ê®°Âºè‰∏ã‰∏çÈúÄË¶ÅÈáçÊñ∞Ê∏≤ÊüìÔºåÈÅøÂÖçÈáçÂ§çÂºπÂá∫ÈÄâÊã©Âô®
            if (currentMode !== 'random') {
                displayVocabulary();
            }
        }

        // Ëé∑ÂèñÂΩìÂâçÁ≠õÈÄâÁöÑÂçïËØç
        function getFilteredWords() {
            let filtered = vocabulary;

            if (currentFilter !== 'all') {
                filtered = filtered.filter(word => word.theme == currentFilter);
            }

            if (currentLetter !== 'all') {
                filtered = filtered.filter(word => word.dutch[0].toUpperCase() === currentLetter);
            }

            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(word =>
                    word.dutch.toLowerCase().includes(searchTerm) ||
                    word.english.toLowerCase().includes(searchTerm)
                );
            }

            return filtered.length > 0 ? filtered : vocabulary;
        }


        // ÂàùÂßãÂåñ‰∫ã‰ª∂Â§ÑÁêÜ
        function initRandomModal() {
            // ÂàùÂßãÂåñ‰ªäÊó•Êü•ÁúãËÆ∞ÂΩï
            initDailyViewedWords();

            // Á°Æ‰øùÊòæÁ§∫ÂÖÉÁ¥†Â≠òÂú®Âπ∂Êõ¥Êñ∞
            const viewedDisplay = document.getElementById('viewedWordsDisplay');
            if (viewedDisplay) {
                viewedDisplay.style.display = 'block';
            }
            updateViewedWordsDisplay();

            const modal = document.getElementById('randomModal');

            // ‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÊ®°ÊÄÅÊ°ÜÂÜÖÁöÑÁÇπÂáª‰∫ã‰ª∂
            modal.addEventListener('click', function(e) {
                // Â¶ÇÊûúÊ®°ÊÄÅÊ°ÜÊú™ÊâìÂºÄÔºåËøîÂõû
                if (!modal.classList.contains('active')) return;

                const target = e.target;

                // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
                if (target === modal) {
                    closeRandomModal();
                    return;
                }

                // Â§ÑÁêÜÂÖ≥Èó≠ÊåâÈíÆ (√ó)
                if (target.id === 'modalCloseBtn' || target.classList.contains('modal-close')) {
                    e.stopPropagation();
                    closeRandomModal();
                    return;
                }

                // Â§ÑÁêÜÂÖ≥Èó≠ÊåâÈíÆ
                if (target.id === 'closeBtn') {
                    e.stopPropagation();
                    closeRandomModal();
                    return;
                }

                // Â§ÑÁêÜ‰∏ã‰∏Ä‰∏™ÂçïËØçÊåâÈíÆ
                if (target.id === 'nextWordBtn') {
                    e.stopPropagation();
                    showRandomWord();
                    return;
                }

                // Â§ÑÁêÜÂèëÈü≥ÊåâÈíÆ
                if (target.classList.contains('speak-btn-modal')) {
                    e.stopPropagation();
                    // onclickÂ∑≤Âú®HTML‰∏≠Â§ÑÁêÜ
                    return;
                }

                // Â§ÑÁêÜÂç°ÁâáÁÇπÂáªÔºàÁøªËΩ¨Ôºâ
                const card = target.closest('#currentRandomCard');
                if (card && !target.classList.contains('speak-btn-modal')) {
                    e.stopPropagation();
                    card.classList.toggle('flipped');
                    return;
                }
            });

            // ÈîÆÁõòÂø´Êç∑ÈîÆ - ÁßªÂà∞modalÂ§ñÈÉ®ÔºåÁ°Æ‰øùÂÖ®Â±ÄÁõëÂê¨
        }

        // ÂÖ®Â±ÄÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂú®initRandomModalÂ§ñÈÉ®Ôºâ
        document.addEventListener('keydown', function(e) {
            // Â§ÑÁêÜËØ¶ÁªÜ‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
            const detailModal = document.getElementById('detailModal');
            if (detailModal && detailModal.classList.contains('active')) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDetailModal();
                    return;
                }
            }

            // Â§ÑÁêÜÈöèÊú∫Â≠¶‰π†Ê®°ÊÄÅÊ°Ü
            const randomModal = document.getElementById('randomModal');
            if (randomModal && randomModal.classList.contains('active')) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeRandomModal();
                } else if (e.key === ' ' || e.key === 'Enter') {
                    e.preventDefault();
                    flipRandomCard();
                } else if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    showRandomWord();
                } else if (e.key === 'm' || e.key === 'M') {
                    e.preventDefault();
                    toggleRandomMastery();
                }
            }
        });

        // Âú®DOMContentLoadedÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', initRandomModal);

        // Á≠õÈÄâÂäüËÉΩ
        function filterByTheme(theme) {
            document.querySelectorAll('#themeFilters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === theme.toString()) {
                    btn.classList.add('active');
                }
            });
            currentFilter = theme;
            displayVocabulary();
            StorageManager.savePreferences();
        }

        function filterByLetter(letter) {
            document.querySelectorAll('#letterFilters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.letter === letter.toString()) {
                    btn.classList.add('active');
                }
            });
            currentLetter = letter;
            displayVocabulary();
            StorageManager.savePreferences();
        }

        // Ê®°ÂºèÂàáÊç¢
        function setupEventListeners() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const previousMode = currentMode;
                    currentMode = this.dataset.mode;

                    document.getElementById('cardsView').style.display = currentMode === 'list' ? 'none' : 'grid';
                    document.getElementById('listView').style.display = currentMode === 'list' ? 'block' : 'none';

                    // Â¶ÇÊûúÂàáÊç¢Âà∞ÈöèÊú∫Ê®°ÂºèÔºåÊòæÁ§∫‰∏ªÈ¢òÈÄâÊã©Âô®
                    if (currentMode === 'random' && previousMode !== 'random') {
                        displayVocabulary(true);  // ‰º†ÂÖ•trueË°®Á§∫Ë¶ÅÊòæÁ§∫ÈöèÊú∫Â≠¶‰π†
                    } else {
                        displayVocabulary();
                    }
                    StorageManager.savePreferences();
                };
            });

            // ‰ΩøÁî®Èò≤Êäñ‰ºòÂåñÊêúÁ¥¢
            const debouncedSearch = debounce(displayVocabulary, 300);
            document.getElementById('searchBox').addEventListener('input', debouncedSearch);
        }

        // Êõ¥Êñ∞ÁªüËÆ°
        function updateStats() {
            document.getElementById('totalWords').textContent = vocabulary.length;
            document.getElementById('learnedWords').textContent = learnedWords.size;
            const progress = Math.round((learnedWords.size / vocabulary.length) * 100);
            document.getElementById('progress').textContent = progress + '%';
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function clearSearch() {
            document.getElementById('searchBox').value = '';
            displayVocabulary();
        }

        function shuffleWords() {
            vocabulary.sort(() => Math.random() - 0.5);
            displayVocabulary();
        }

        function resetProgress() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊéåÊè°ËøõÂ∫¶ÂêóÔºü')) {
                learnedWords.clear();
                StorageManager.saveLearnedWords();

                // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÂêåÊ≠•Âà∞‰∫ëÁ´Ø
                if (typeof SyncManager !== 'undefined') {
                    SyncManager.scheduleSave();
                }

                updateStats();

                // ÁßªÈô§Â∑≤Â≠¶‰π†Ê†∑Âºè
                document.querySelectorAll('.word-card.learned').forEach(card => {
                    card.classList.remove('learned');
                });

                displayVocabulary();
            }
        }

        // ÂàÜ‰∫´ÁΩëÁ´ôÂäüËÉΩ
        function shareApp() {
            const shareData = {
                title: 'Ëç∑ÂÖ∞ËØ≠A2ËØçÊ±áÂ≠¶‰π†',
                text: 'ËΩªÈáèÁ∫ßËç∑ÂÖ∞ËØ≠A2ËØçÊ±áÂ≠¶‰π†Â∑•ÂÖ∑ÔºåÊîØÊåÅÁ¶ªÁ∫ø‰ΩøÁî®ÔºÅ',
                url: window.location.href
            };

            // Â¶ÇÊûúÊîØÊåÅÂéüÁîüÂàÜ‰∫´
            if (navigator.share) {
                navigator.share(shareData).catch(err => {
                    // Áî®Êà∑ÂèñÊ∂àÂàÜ‰∫´‰∏çÁÆóÈîôËØØ
                    if (err.name !== 'AbortError') {
                        copyToClipboard();
                    }
                });
            } else {
                // ‰∏çÊîØÊåÅÂéüÁîüÂàÜ‰∫´ÔºåÂ§çÂà∂ÈìæÊé•
                copyToClipboard();
            }
        }

        // Â§çÂà∂ÈìæÊé•Âà∞Ââ™Ë¥¥Êùø
        function copyToClipboard() {
            const url = window.location.href;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ\n' + url);
                }).catch(() => {
                    fallbackCopyToClipboard(url);
                });
            } else {
                fallbackCopyToClipboard(url);
            }
        }

        // ÈôçÁ∫ßÂ§çÂà∂ÊñπÊ°à
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "-999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                alert('ÈìæÊé•Â∑≤Â§çÂà∂Ôºö\n' + text);
            } catch (err) {
                alert('ËØ∑ÊâãÂä®Â§çÂà∂ÈìæÊé•Ôºö\n' + text);
            }
            document.body.removeChild(textArea);
        }

        // Êï∞ÊçÆÂØºÂÖ•ÂØºÂá∫ÂäüËÉΩ
        function exportData() {
            const exportObj = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                learnedWords: [...learnedWords],
                preferences: {
                    filterTheme: currentFilter,
                    filterLetter: currentLetter,
                    viewMode: currentMode
                },
                statistics: {
                    totalWords: vocabulary.length,
                    learnedCount: learnedWords.size,
                    progress: Math.round((learnedWords.size / vocabulary.length) * 100)
                }
            };

            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `dutch-vocabulary-progress-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('ÊéåÊè°ËøõÂ∫¶Â∑≤ÂØºÂá∫ÔºÅ');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importObj = JSON.parse(e.target.result);

                    // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
                    if (!importObj.version || !importObj.learnedWords) {
                        throw new Error('Êó†ÊïàÁöÑÂØºÂÖ•Êñá‰ª∂Ê†ºÂºè');
                    }

                    // ÂØºÂÖ•Â≠¶‰π†ËøõÂ∫¶
                    learnedWords = new Set(importObj.learnedWords);
                    StorageManager.saveLearnedWords();

                    // ÂØºÂÖ•ÂÅèÂ•ΩËÆæÁΩÆ
                    if (importObj.preferences) {
                        currentFilter = importObj.preferences.filterTheme || 'all';
                        currentLetter = importObj.preferences.filterLetter || 'all';
                        currentMode = importObj.preferences.viewMode || 'cards';
                        StorageManager.savePreferences();
                    }

                    // ÊÅ¢Â§çÁïåÈù¢Áä∂ÊÄÅ
                    restoreFilterStates();
                    updateStats();
                    displayVocabulary();

                    alert(`ÊàêÂäüÂØºÂÖ•ÊéåÊè°ËøõÂ∫¶ÔºÅ\nÂ∑≤ÊéåÊè°ÂçïËØçÔºö${learnedWords.size} ‰∏™`);
                } catch (error) {
                    alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + error.message);
                }

                // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        // ÂêØÂä®Â∫îÁî®
        init();
    </script>

    <!-- ÁôªÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <button class="login-close" onclick="hideLoginModal()">√ó</button>
            <div class="login-title">ÁôªÂΩïÂêåÊ≠•</div>
            <div class="login-subtitle">ËæìÂÖ•ÈÇÆÁÆ±ÔºåÊàë‰ª¨‰ºöÂèëÈÄÅÁôªÂΩïÈìæÊé•Áªô‰Ω†</div>
            <form onsubmit="handleLogin(event); return false;">
                <input
                    type="email"
                    id="emailInput"
                    class="email-input"
                    placeholder="your@email.com"
                    required
                >
                <button type="submit" id="loginBtn" class="login-submit">
                    ÂèëÈÄÅÁôªÂΩïÈìæÊé•
                </button>
            </form>
        </div>
    </div>

    <!-- ËØ≠Ê≥ïËßÑÂàôÊù•Ê∫êËØ¥Êòé -->
    <div style="position: fixed; bottom: 10px; right: 10px; background: rgba(255, 255, 255, 0.9); padding: 8px 12px; border-radius: 5px; font-size: 11px; color: #666; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        ËØ≠Ê≥ïËßÑÂàôÂü∫‰∫é <a href="https://www.dutchgrammar.com" target="_blank" style="color: #667eea;">dutchgrammar.com</a> & <a href="https://www.learndutch.org" target="_blank" style="color: #667eea;">learndutch.org</a>
    </div>
</body>
</html>